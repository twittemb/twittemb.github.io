<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Warp your mobile development"/><link rel="canonical" href="http://blog.warpfactor.io/posts/2021-02-13-StateMachineDSL"/><meta name="twitter:url" content="http://blog.warpfactor.io/posts/2021-02-13-StateMachineDSL"/><meta name="og:url" content="http://blog.warpfactor.io/posts/2021-02-13-StateMachineDSL"/><title>A DSL for state machines in Swift | Warp your mobile development</title><meta name="twitter:title" content="A DSL for state machines in Swift | Warp your mobile development"/><meta name="og:title" content="A DSL for state machines in Swift | Warp your mobile development"/><meta name="description" content="State machines are great tools to describe systems with a finite number of states. They are predictable and testable, which is something we praise for as developers. State machines can be defined in a pretty abstract way, which makes it a good candidate for a Domain Specific Language implementation. In this article, we will try to create a DSL that can describe state machines in Swift and use it in a feedback loop architecture."/><meta name="twitter:description" content="State machines are great tools to describe systems with a finite number of states. They are predictable and testable, which is something we praise for as developers. State machines can be defined in a pretty abstract way, which makes it a good candidate for a Domain Specific Language implementation. In this article, we will try to create a DSL that can describe state machines in Swift and use it in a feedback loop architecture."/><meta name="og:description" content="State machines are great tools to describe systems with a finite number of states. They are predictable and testable, which is something we praise for as developers. State machines can be defined in a pretty abstract way, which makes it a good candidate for a Domain Specific Language implementation. In this article, we will try to create a DSL that can describe state machines in Swift and use it in a feedback loop architecture."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Warp your mobile development"/></head><head>                <!-- Global site tag (gtag.js) - Google Analytics -->
                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109460106-1"></script>
                <script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());

                  gtag('config', 'UA-109460106-1');
                </script></head><body class="bg-white font-sans leading-normal tracking-normal"><div class="pb-16"><nav class="fixed z-10 bg-gray-900 p-4 mt-0 w-full overflow-auto scrolling-touch"><div class="container mx-auto flex items-center"><div class="flex-shrink-0 text-white font-extrabold"><a class="flex text-white text-base no-underline hover:text-white hover:no-underline" href="/"><span class="block md:hidden md:w-auto pl-1">üçè</span><span class="hidden md:block w-0 md:w-auto pl-1">Warp your mobile development</span></a></div><div class=" flex flex-no-wrap pl-4 text-sm"><ul class="list-reset flex justify-between items-center"><li class="mr-2"><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-2" href="/">HOME</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-2 whitespace-no-wrap" href="/projects">PROJECTS</a></li><li><a class="inline-block py-2 px-2 text-white no-underline hover:underline whitespace-no-wrap" href="/posts">MY POSTS</a></li></ul></div></div></nav></div><div class="text-center pt-16 md:pt-32"><p class="text-xs md:text-sm text-casper-blue font-bold">13 FEBRUARY 2021<span class="text-gray-900 px-1">/</span><a href="/tags/architecture">ARCHITECTURE</a>, <a href="/tags/open-source">OPEN SOURCE</a>, <a href="/tags/language">LANGUAGE</a></p><h1 class="font-bold break-normal text-3xl md:text-5xl max-w-6xl mx-auto">A DSL for state machines in Swift</h1></div><div class="container w-full max-w-6xl h-48 md:h-cover mx-auto bg-white bg-cover bg-center mt-8 sm:rounded" style="background-color: #465059; background-image:url('/Images/2021-02-13-StateMachineDSL/header.png');"></div><div class="container max-w-5xl mx-auto md:-mt-32"><div class="mx-0 sm:mx-6"><main class="bg-white w-full p-8 md:p-24 text-gray-800 leading-normal"><article class="prose prose-sm sm:prose-xl break-words"><h1>About state machines</h1><blockquote><p>A state machine is an abstract machine that can only be in one of a finite number of states at any given time. The state machine can change from one state to another in response to some external events. The change from one state to another is called a transition. A state machine is defined by a list of its states, its initial state, and the conditions for each transition.</p></blockquote><p>A State machine is a simple, yet powerful tool to build a feature in an application.</p><ul><li>It is predictable, so it is testable</li><li>It is a reference you can share with your teammates to reason about a feature</li><li>It can be described in an abstract way and then be implemented with whatever programming language</li></ul><p>As developers, and especially mobile developers, we often have to implement features that can be summed up by the following screens:</p><img src="/Images/2021-02-13-StateMachineDSL/screens.png"/><p>Each <em>screen-state</em> has to be exclusive. We want our screens to be consistent, and to display one state at a time. A screen cannot be both Saved and Failed.</p><p>To enforce this, we can take advantage of finite state machines as they ensure that two states cannot overlap.</p><img src="/Images/2021-02-13-StateMachineDSL/state-machine.png"/><p>As you can see, the state machine matches exactly the sequence of screens we described earlier. Each new state is computed based on the <em>current state</em> plus an <em>input</em> (such as a user input or a network call result).</p><p>Lately, a lot of architectures, mostly unidirectional architectures, tend to promote "state machine like" patterns:</p><ul><li><a href="https://dennisreimann.de/articles/elm-architecture-overview.html">MVU/ELM</a></li><li><a href="https://redux.js.org/style-guide/style-guide#treat-reducers-as-state-machines">Redux</a></li><li>Feedback Loops: <a href="https://github.com/CombineCommunity/Feedbacks">Feedbacks</a>, <a href="https://github.com/CombineCommunity/Feedbacks">RxFeedback</a>, <a href="https://github.com/ReactiveCocoa/Loop">Loop</a></li></ul><p>Most of the time, they implement their state machines thanks to a <strong>reducer</strong> function. A reducer is a <a href="https://en.wikipedia.org/wiki/Pure_function">pure function</a> that takes the current state, an event, and outputs the new state.</p><p>Here is our state machine implemented in a pseudo-code:</p><pre><code><div class="highlight"><span></span><span class="n">reducer</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">State</span> <span class="p">{</span>
  <span class="n">IF</span> <span class="n">state</span> <span class="p">=</span> <span class="n">Loading</span> <span class="n">AND</span> <span class="n">event</span> <span class="p">=</span> <span class="n">LoadingSuccessful</span> <span class="n">RETURN</span> <span class="n">Saving</span>
  <span class="n">IF</span> <span class="n">state</span> <span class="p">=</span> <span class="n">Loading</span> <span class="n">AND</span> <span class="n">event</span> <span class="p">=</span> <span class="n">LoadingFailed</span> <span class="n">RETURN</span> <span class="n">Failed</span>
  <span class="n">IF</span> <span class="n">state</span> <span class="p">=</span> <span class="n">Saving</span> <span class="n">AND</span> <span class="n">event</span> <span class="p">=</span> <span class="n">SavingSuccessful</span> <span class="n">RETURN</span> <span class="n">Saved</span>
  <span class="n">IF</span> <span class="n">state</span> <span class="p">=</span> <span class="n">Saving</span> <span class="n">AND</span> <span class="n">event</span> <span class="p">=</span> <span class="n">SavingFailed</span> <span class="n">RETURN</span> <span class="n">Failed</span>
<span class="p">}</span>
</div></code></pre><h1>What is a DSL ?</h1><blockquote><p>Without DSLs, there is no World Wide Web as we know it!</p></blockquote><p>A domain-specific language (DSL) is a computer language specialized to a particular application domain. <strong>HTML</strong> for instance, is a domain-specific markup language, whose domain is to describe the layout of a document displaying information. The domain of the HTML language contains concepts such as <strong>HEAD</strong>, <strong>BODY</strong>, <strong>TABLE</strong>, <strong>IMG</strong>. These keywords only have meaning within the context of the syntax defined by the HTML DSL.</p><p>We can make an interesting connection between DSLs and ontologies. An <a href="https://en.wikipedia.org/wiki/Ontology_(information_science">ontology</a> describes a domain of knowledge by defining its constituting concepts and the relationships between them. There are some languages to model ontologies, such as <a href="https://en.wikipedia.org/wiki/Resource_Description_Framework">RDF</a> or <a href="https://en.wikipedia.org/wiki/Web_Ontology_Language">OWL</a>. In a way, those languages are Meta DSLs, as they offer generic syntaxes to define a domain. We could say that a DSL is a concrete implementation of an ontology.</p><p>There are several types of DSLs:</p><ul><li>External DSLs, such as HTML. They require an independent interpreter to be executed.</li><li>Internal DSLs (or embedded DSL) are defined in the terms of a host language. The great thing about them is that the language compiler will check the document to ensure it respects both your DSL and the host programming language syntax. In addition to using custom terms from the domain, you are also able to use traditional programming statements (if, else, switch, ‚Ä¶) which will dynamically impact its interpretation.</li></ul><p>There are some famous examples of DSLs: HTLM, Gradle, SQL, SwiftUI, Gherkin.</p><img src="/Images/2021-02-13-StateMachineDSL/gherkin.png"/><p><em>Here is a unit test expressed in the Gherkin DSL. </em></p><h1>Why DSLs ?</h1><p>DSLs are meant for experts of a domain to be able to create content and share it without having to deal with the complexity of a fully featured programming language.</p><p>A DSL, having a syntax limited to a precise domain, can be modelled with a dedicated graphical tool and can also lead to code and documentation generation. The experts can focus on their domain from a high level perspective and still generate an optimized source code.</p><p><a href="https://www.jetbrains.com/mps/">JetBrains MPS</a> is a nice example of a graphical tool that one can use to elaborate and use DSLs. From a process designed thanks to a DSL, it can generate source code in programming languages such as Java, C, Javascript, etc. The code can then be integrated in an enterprise information system to execute the processes defined by the experts. This kind of tool attempts to fill the gap between domain experts and developers.</p><p>Embedded DSLs are more developer oriented, and are generally meant to provide libraries with a narrowed syntax compared to their host language.</p><p>For instance, we can imagine the previous Gherkin example being written thanks to an embedded DSL inside a Swift Unit Test.</p><pre><code><div class="highlight"><span></span><span class="kd">var</span> <span class="nv">balance</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span>

<span class="n">Scenario</span><span class="p">(</span><span class="s">&quot;A user attempts to withdraw more money than they have in their account&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Given</span><span class="p">(</span><span class="s">&quot;John has a valid Credit or Debit card and his balance is 20$&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">balance</span> <span class="p">=</span> <span class="mi">20</span>
  <span class="p">}</span>
	
  <span class="n">When</span><span class="p">(</span><span class="s">&quot;John withdraws 40$&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">balance</span> <span class="o">-=</span> <span class="mi">40</span>
  <span class="p">}</span>
	
  <span class="n">Then</span> <span class="p">{</span>
    <span class="n">Error</span><span class="p">(</span><span class="s">&quot;The ATM displays an error&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ATM</span><span class="p">.</span><span class="n">Error</span><span class="p">.</span><span class="n">notEnoughCredit</span>
    <span class="p">}</span>
    <span class="n">Result</span><span class="p">(</span><span class="s">&quot;The balance is still 20$&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">balance</span> <span class="p">==</span> <span class="mi">20</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>Under the hood, this DSL will be translated into <code>XCTest</code> related code.</p><p>One advantage of embedded DSLs for languages like Swift and Kotlin is their very similar syntax which allows for sharing ideas and implementations, and also for the ease of cross platform reviews.</p><h1>Modeling state machines with a DSL</h1><p>State machines have fairly simple concepts such as: State, Event, Transition. The resulting DSL should be pretty easy to implement, at least from a syntax perspective.</p><p>Nevertheless, implementing a <strong>finite state machine</strong> DSL might come with some challenges regarding the Swift type system, as "<strong>finite</strong>" implies to restrain the number of possible states.</p><h2>Algebraic Types</h2><p>In order to pick the appropriate type to model a State, we first need to understand algebraic types.</p><p>In computer science, algebraic types are data types that can be composed of other types. Usually, algebraic types are split into two categories: product types and sum types.</p><p><strong>Product types</strong> can contain several fields, and the number of different values for this type is the product of the possible values of each field. In Swift, <strong>Struct</strong> is an algebraic product type.</p><pre><code><div class="highlight"><span></span><span class="kd">enum</span> <span class="nc">Letter</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">A</span>
  <span class="k">case</span> <span class="n">B</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">Z</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="nc">Number</span> <span class="p">{</span>
  <span class="k">case</span> <span class="mi">1</span>
  <span class="k">case</span> <span class="mi">2</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="mi">10</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Reference</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">letter</span><span class="p">:</span> <span class="n">Letter</span>
  <span class="kd">let</span> <span class="nv">number</span><span class="p">:</span> <span class="n">Number</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">ref1</span> <span class="p">=</span> <span class="n">Reference</span><span class="p">(</span><span class="n">letter</span><span class="p">:</span> <span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="p">.</span><span class="mi">1</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">ref2</span> <span class="p">=</span> <span class="n">Reference</span><span class="p">(</span><span class="n">letter</span><span class="p">:</span> <span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="p">.</span><span class="mi">2</span><span class="p">)</span>
<span class="p">...</span>
<span class="kd">let</span> <span class="nv">ref260</span> <span class="p">=</span> <span class="n">Reference</span><span class="p">(</span><span class="n">letter</span><span class="p">:</span> <span class="p">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="p">.</span><span class="mi">10</span><span class="p">)</span>
</div></code></pre><p>As you can see, the number of possible values for the <strong>Reference</strong> type is equal to the product of all the possible values of its fields: <strong>26 x 10 = 260</strong>.</p><p><strong>Sum types</strong>, aka "tagged unions", stand for types that can have one value at a time among a finite set of possible values. The numer of different values for this type if the sum of all its possible exclusive values. In Swift, <strong>Enum</strong> is an algebraic sum type.</p><pre><code><div class="highlight"><span></span><span class="kd">enum</span> <span class="nc">Reference</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">letter</span><span class="p">(</span><span class="n">Letter</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">number</span><span class="p">(</span><span class="n">Number</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">ref1</span> <span class="p">=</span> <span class="n">Reference</span><span class="p">.</span><span class="n">letter</span><span class="p">(.</span><span class="n">A</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">ref2</span> <span class="p">=</span> <span class="n">Reference</span><span class="p">.</span><span class="n">letter</span><span class="p">(.</span><span class="n">B</span><span class="p">)</span>
<span class="p">...</span>
<span class="kd">let</span> <span class="nv">ref36</span> <span class="p">=</span> <span class="n">Reference</span><span class="p">.</span><span class="n">number</span><span class="p">(.</span><span class="mi">10</span><span class="p">)</span>
</div></code></pre><p>As you can see, the number of possible values for the <strong>Reference</strong> type is equal to the sum of all the possible values of each case: <strong>26 + 10 = 36</strong>.</p><h2>What does it mean regarding states ?</h2><p>In order to implement a finite state machine, we need the states to have a finite number of values, and we need them to be mutually exclusive. In other words, we need them to be represented by sum types, let's see why.</p><p>Product types are bad candidates as they allow to mix incompatible values. For instance:</p><pre><code><div class="highlight"><span></span><span class="kd">enum</span> <span class="nc">MyError</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">network</span>
  <span class="k">case</span> <span class="n">database</span>
  <span class="k">case</span> <span class="n">filesystem</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">MyState</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">error</span><span class="p">:</span> <span class="n">MyError</span><span class="p">?</span>
  <span class="kd">let</span> <span class="nv">value</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">state1</span> <span class="p">=</span> <span class="n">MyState</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">state2</span> <span class="p">=</span> <span class="n">MyState</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">state3</span> <span class="p">=</span> <span class="n">MyState</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">state4</span> <span class="p">=</span> <span class="n">MyState</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="p">.</span><span class="n">network</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">...</span>
<span class="kd">let</span> <span class="nv">state12</span> <span class="p">=</span> <span class="n">MyState</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="p">.</span><span class="n">filesystem</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
</div></code></pre><p>Using MyState as a struct could lead to inconsistent behaviours since it can be simultaneously an error and a valid value. There are <strong>4 x 3 = 12</strong> fuzzy possible states.</p><p>On the other hand, sum types are much more restrictive:</p><pre><code><div class="highlight"><span></span><span class="kd">enum</span> <span class="nc">MyState</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">error</span><span class="p">(</span><span class="n">MyError</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">value</span><span class="p">(</span><span class="nb">Bool</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">state1</span> <span class="p">=</span> <span class="n">MyState</span><span class="p">.</span><span class="n">error</span><span class="p">(.</span><span class="n">network</span><span class="p">)</span>
<span class="p">...</span>
<span class="kd">let</span> <span class="nv">state5</span> <span class="p">=</span> <span class="n">MyState</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</div></code></pre><p>Using MyState as an enum allows only: <strong>3 + 2 = 5</strong> possible mutually exclusive states.</p><h2>But there is an issue with enums</h2><p>When designing a DSL, one of the main goals is to provide a simple, yet expressive syntax. You want it to be as close as possible to natural language. If we had to define the transition between a <strong>saving</strong> and a <strong>saved</strong> state, we could want to write something like:</p><pre><code><div class="highlight"><span></span><span class="kd">enum</span> <span class="nc">MyState</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">loading</span>
  <span class="k">case</span> <span class="n">saving</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">saved</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">failed</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="nc">MyEvent</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">loadingSuccessful</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">loadingFailed</span>
  <span class="k">case</span> <span class="n">savingSuccessful</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">savingFailed</span>
<span class="p">}</span>

<span class="n">Transition</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">MyState</span><span class="p">.</span><span class="n">saving</span><span class="p">(</span><span class="kd">let</span> <span class="nv">data</span><span class="p">),</span> <span class="n">on</span><span class="p">:</span> <span class="n">MyEvent</span><span class="p">.</span><span class="n">savingSuccessful</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="n">data</span> <span class="k">in</span>
  <span class="k">return</span> <span class="n">MyState</span><span class="p">.</span><span class="n">saved</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="p">})</span>
</div></code></pre><p>The problem with this code is that <code>MyState.saving(let data)</code> won't even compile since extracting an embedded value must occur in the context of a pattern matching (<code>switch</code>, <code>if case let</code>). We could include some pattern matching in this DSL, but it would make it pretty ugly to read:</p><pre><code><div class="highlight"><span></span><span class="n">Transition</span><span class="p">(</span>
  <span class="n">from</span><span class="p">:</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="kd">let</span> <span class="p">.</span><span class="n">saving</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">=</span> <span class="n">state</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span> 
  <span class="p">},</span>
  <span class="n">on</span><span class="p">:</span> <span class="n">MyEvent</span><span class="p">.</span><span class="n">savingSuccessful</span><span class="p">,</span>
  <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="n">extractedData</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">extractedData</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">MyState</span><span class="p">.</span><span class="n">failed</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">MyState</span><span class="p">.</span><span class="n">saved</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">)</span>
</div></code></pre><p>If I had to use a DSL, I would not want to use this one.</p><p>We need a type that can embed values and at the same time provide a unique identifier for each state and event.</p><p>What if we use structs to model our states/events, and leverage the struct type as a unique identifier ? After all, concrete types can be considered as mutually exclusive in the set of all possible Swift types. If you are familiar with Kotlin, it looks a lot like the <code>sealed class</code> concept.</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">Saving</span> <span class="p">{</span> <span class="kd">let</span> <span class="nv">data</span><span class="p">:</span> <span class="n">Data</span> <span class="p">}</span>
<span class="kd">struct</span> <span class="nc">Saved</span> <span class="p">{</span> <span class="kd">let</span> <span class="nv">data</span><span class="p">:</span> <span class="n">Data</span> <span class="p">}</span>

<span class="kd">struct</span> <span class="nc">SavingSuccessful</span> <span class="p">{</span> <span class="kd">let</span> <span class="nv">data</span><span class="p">:</span> <span class="n">Data</span> <span class="p">}</span>

<span class="n">Transition</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">Saving</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">SavingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="n">state</span><span class="p">,</span> <span class="n">event</span> <span class="k">in</span>
  <span class="n">Saved</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// or even shorter:</span>

<span class="n">Transition</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">Saving</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">SavingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="n">Saved</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nv">$1</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</div></code></pre><p>It looks definitely better.</p><p>My point here is to not assert that one type is better than others to model a state/event concept in a state machine. Each type has its pros and cons. For instance, <a href="https://github.com/pointfreeco/swift-case-paths">Pointfree has released a library</a> to deal with enum's embedded values as keypaths. That could make enums good candidates to be used in a state machine DSL, while keeping a nice syntax.</p><p>I made the choice to use struct's type as an identifier because it fits the need of state machine DSL without depending on a third party library; moreover, structs are compatible with pattern matching, which will be helpful to interpret the current state of a system when we need it.</p><h1>Result builder</h1><p>Now that we've chosen the data types that will model our states and events, we can design our DSL. Obviously, the chances are great that a state machine has more than one transition. The machine will be <strong>composed</strong> of several transitions or group of transitions. The important word here is: <strong>composed</strong>. As soon as an entity is composed of several sub-entities, we can leverage the <strong>builder pattern</strong> to construct the root entity.</p><p>For instance, if a state machine declares 3 transitions:</p><pre><code><div class="highlight"><span></span><span class="kd">let</span> <span class="nv">transitions</span> <span class="p">=</span> <span class="n">Transitions</span><span class="p">()</span>
  <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">LoadingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}))</span>
  <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">LoadingFailure</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}))</span>
  <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">From</span><span class="p">(</span><span class="n">Saving</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">SavingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}))</span>
  <span class="p">.</span><span class="n">build</span><span class="p">()</span>
	
<span class="c1">// or</span>

<span class="kd">let</span> <span class="nv">transitions</span> <span class="p">=</span> <span class="n">Transitions</span><span class="p">([</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">LoadingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}),</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">LoadingFailure</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}),</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Saving</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">SavingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">})</span>
<span class="p">])</span>
</div></code></pre><p>Altough it is valid Swift, it is not a nice API, especially in the context of a DSL.</p><p>Within the Apple programming ecosystem, there is another domain that heavily relies on composition: UI frameworks, and particularly SwiftUI. We can take advantage of one of the mechanisms SwiftUI uses to provide a nice way of compositing transitions: <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0289-result-builders.md"><strong>Result Builder</strong></a>.</p><p>Basically, a <strong>Result Builder</strong> is just a way to aggregate several inputs and compute a result with them.</p><pre><code><div class="highlight"><span></span><span class="p">@</span><span class="n">resultBuilder</span>
<span class="kd">struct</span> <span class="nc">StringBuilder</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="kd">func</span> <span class="nf">buildBlock</span><span class="p">(</span><span class="kc">_</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">String</span><span class="p">...)</span> <span class="p">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
     <span class="n">inputs</span><span class="p">.</span><span class="n">joined</span><span class="p">(</span><span class="n">separator</span><span class="p">:</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="n">StringBuilder</span>
<span class="kd">var</span> <span class="nv">sentence</span><span class="p">:</span> <span class="nb">String</span> <span class="p">{</span>
  <span class="s">&quot;To boldly go&quot;</span>
  <span class="s">&quot;where no one&quot;</span>
  <span class="s">&quot;has gone before&quot;</span>
<span class="p">}</span>

<span class="c1">// all the values declared in the `sentence` definition</span>
<span class="c1">// will be passed to the `buildBlock` function as separate inputs, and the</span>
<span class="c1">// resulting value will be the full sentence:</span>
<span class="c1">// &quot;To boldly go</span>
<span class="c1">// where no one</span>
<span class="c1">// has gone before&quot;</span>
</div></code></pre><p>With this kind of mechanisms we could write a <code>@TransitionBuilder</code> that would allow us to write:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">From</span> <span class="p">{</span>
   <span class="c1">// wraps a state id, an event id and the transition to apply</span>
   <span class="p">...</span>
<span class="p">}</span>

<span class="p">@</span><span class="n">resultBuilder</span>
<span class="kd">struct</span> <span class="nc">TransitionBuilder</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="kd">func</span> <span class="nf">buildBlock</span><span class="p">(</span><span class="kc">_</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">From</span><span class="p">...)</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="n">From</span><span class="p">]</span> <span class="p">{</span>
     <span class="n">inputs</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Transitions</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">transitions</span><span class="p">:</span> <span class="p">[</span><span class="n">From</span><span class="p">]</span>
  
  <span class="kd">init</span><span class="p">(@</span><span class="n">TransitionBuilder</span> <span class="kc">_</span> <span class="n">transitions</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="n">From</span><span class="p">])</span> <span class="p">{</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">transitions</span> <span class="p">=</span> <span class="n">transitions</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="n">TransitionBuilder</span>
<span class="kd">var</span> <span class="nv">transitions</span><span class="p">:</span> <span class="n">Transitions</span> <span class="p">{</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">LoadingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">})</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">LoadingFailure</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">})</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Saving</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">SavingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// or something like</span>

<span class="kd">let</span> <span class="nv">transitions</span> <span class="p">=</span> <span class="n">Transitions</span> <span class="p">{</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">LoadingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">})</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">LoadingFailure</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">})</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Saving</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">SavingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">then</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">})</span>
<span class="p">}</span>
</div></code></pre><h1>A glance at a concrete DSL implementation</h1><p>In the context of the <a href="https://github.com/CombineCommunity/Feedbacks">CombineCommunity Feedbacks</a> framework, I had to build a state machine DSL that would be integrated inside a feedback loop definition.</p><p>Here are some of the concepts I had to implement.</p><h2>Types as identifier</h2><p>In a <strong>state machine</strong>, transitions are identified by the pair: current state + event. As mentionned, I've decided to use the states and events types to identify them. I needed some tooling to do so:</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">StaticIdentifiable</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="n">AnyHashable</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">extension</span> <span class="nc">StaticIdentifiable</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="n">AnyHashable</span> <span class="p">{</span>
    <span class="nb">String</span><span class="p">(</span><span class="n">reflecting</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nv">instanceId</span><span class="p">:</span> <span class="n">AnyHashable</span> <span class="p">{</span>
    <span class="kc">Self</span><span class="p">.</span><span class="n">id</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="nc">State</span><span class="p">:</span> <span class="n">StaticIdentifiable</span> <span class="p">{}</span>
<span class="kd">protocol</span> <span class="nc">Event</span><span class="p">:</span> <span class="n">StaticIdentifiable</span> <span class="p">{}</span>
</div></code></pre><p>As each states and each events conform to <code>StaticIdentifiable</code>, their type can form a unique pair when declared in a transition. All the declared transitions can then be indexed in a dictionary by this unique pair. The reducer infered from these transitions can refer to this dictionary to compute the transition to apply when receiving a state and an event.</p><h2>Transitions definition</h2><p>A transition is defined by a <code>From</code> and an <code>On</code> keywords in our DSL. Reading a state machine should feel natural: <code>From the "Loading" state, On the "LoadingHasSucceeded" event, Transition to a new state</code>.</p><p>It should also be possible to group transitions from the same state in order to allow a concise syntax:</p><pre><code><div class="highlight"><span></span><span class="kd">let</span> <span class="nv">transitions</span> <span class="p">=</span> <span class="n">Transitions</span> <span class="p">{</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">currentState</span> <span class="k">in</span> 
    <span class="n">On</span><span class="p">(</span><span class="n">LoadingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">event</span> <span class="k">in</span>
      <span class="c1">// compute new state based on currentState and event</span>
    <span class="p">}</span>
    
    <span class="n">On</span><span class="p">(</span><span class="n">LoadingFailure</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">transitionTo</span><span class="p">:</span> <span class="n">Failed</span><span class="p">())</span>  
  <span class="p">}</span>
  
  <span class="n">From</span><span class="p">(</span><span class="n">Saving</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">currentState</span> <span class="k">in</span>
    <span class="n">On</span><span class="p">(</span><span class="n">SavingSuccessful</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">event</span> <span class="k">in</span>
      <span class="c1">// compute new state based on currentState and event</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>With this in place, we have a basic DSL to generate a state machine reducer function. The true <a href="https://github.com/CombineCommunity/Feedbacks">CombineCommunity Feedbacks</a> implementation of a DSL is very similar to what we can see here.</p><p>It also brings the concept of <strong>modifiers</strong> to the syntax (just like with SwiftUI). This lets us write things like:</p><pre><code><div class="highlight"><span></span><span class="kd">let</span> <span class="nv">transitions</span> <span class="p">=</span> <span class="n">Transitions</span> <span class="p">{</span>
  <span class="n">From</span><span class="p">(</span><span class="n">Saved</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">On</span><span class="p">(</span><span class="n">RefreshData</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">transitionsTo</span><span class="p">:</span> <span class="n">Loading</span><span class="p">())</span>
  <span class="p">}</span>
  <span class="p">.</span><span class="n">disable</span> <span class="p">{</span>
    <span class="o">!</span><span class="n">profile</span><span class="p">.</span><span class="n">isSuperUser</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>Where the <code>disable</code> modifier dynamically changes the behavior of the transition. If the profile is not <code>superUser</code> then this transition can never be executed. The <code>disable</code> condition will be evaluated every time the state machine involves the pair <code>Saved.self / RefreshData.self</code>.</p><h2>An example of usage</h2><p>The <code>Feedbacks</code> repo contains some example applications that demonstrate the use of a DSL written state machine in a feedback loop system.</p><p>The following system is inspired by a <a href="https://github.com/CombineCommunity/Feedbacks/tree/main/Examples">real life example</a> that loads the trending gifs against the paginated <strong>Giphy API</strong>.</p><pre><code><div class="highlight"><span></span><span class="n">System</span> <span class="p">{</span>
  <span class="n">InitialState</span> <span class="p">{</span>
    <span class="n">Loading</span><span class="p">(</span><span class="n">page</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">Feedbacks</span> <span class="p">{</span>
    <span class="c1">// the side effect performs the network call when the state is Loading</span>
    <span class="n">Feedback</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="p">.</span><span class="n">cancelOnNewState</span><span class="p">,</span> <span class="n">perform</span><span class="p">:</span> <span class="n">loadSideEffect</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">Transitions</span> <span class="p">{</span>
    <span class="c1">// Loading transitions</span>
    <span class="n">From</span><span class="p">(</span><span class="n">Loading</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">currentState</span> <span class="k">in</span>
      <span class="n">On</span><span class="p">(</span><span class="n">LoadingIsComplete</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">event</span> <span class="k">in</span>
        <span class="n">Loaded</span><span class="p">(</span><span class="n">page</span><span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">page</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">event</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span>
      <span class="p">}</span>
      
      <span class="n">On</span><span class="p">(</span><span class="n">LoadingHasFailed</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">transitionTo</span><span class="p">:</span> <span class="n">Failed</span><span class="p">())</span>
    <span class="p">}</span>
  
    <span class="c1">// Loaded transitions</span>
    <span class="n">From</span><span class="p">(</span><span class="n">Loaded</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">currentState</span> <span class="k">in</span>
      <span class="n">On</span><span class="p">(</span><span class="n">Refresh</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">transitionTo</span><span class="p">:</span> <span class="n">Loading</span><span class="p">(</span><span class="n">page</span><span class="p">:</span> <span class="n">currentState</span><span class="p">.</span><span class="n">page</span><span class="p">))</span>
      <span class="n">On</span><span class="p">(</span><span class="n">LoadPrevious</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">transitionTo</span><span class="p">:</span> <span class="n">Loading</span><span class="p">(</span><span class="n">page</span><span class="p">:</span> <span class="n">currentState</span><span class="p">.</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
      <span class="n">On</span><span class="p">(</span><span class="n">LoadNext</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">transitionTo</span><span class="p">:</span> <span class="n">Loading</span><span class="p">(</span><span class="n">page</span><span class="p">:</span> <span class="n">currentState</span><span class="p">.</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// Failed transitions</span>
    <span class="n">From</span><span class="p">(</span><span class="n">Failed</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">On</span><span class="p">(</span><span class="n">Refresh</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">transitionTo</span><span class="p">:</span> <span class="n">Loading</span><span class="p">(</span><span class="n">page</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>To be fully accurate on the type of state machine <strong>Feedbacks</strong> relies on, we can speak of a <a href="https://en.wikipedia.org/wiki/Moore_machine">Moore state machine</a>. If we consider the side effects as the outputs of the state machine, they are determined only by the current state, whereas <a href="https://en.wikipedia.org/wiki/Mealy_machine">Mealy state machines</a> need a pair state + input to generate an output.</p><h1>Conclusion</h1><p>I have not encountered many Swift implementations of state machine DSLs, especially based on <code>ResultBuilder</code>. There is an interesting one in Kotlin made by <a href="https://github.com/Tinder/StateMachine">Tinder</a>. It looks pretty similar to what I've designed (but it uses a Mealy state machine).</p><p>With the official introduction of <code>ResultBuilder</code> in Swift 5.4, I'm sure that DSL based projects will gain in popularity on GitHub and a commonly used pattern might emerge regarding state machines.</p><p>In the meantime, feel free to reach out to give me your feedback and ideas about state machines and DSLs.</p><p>PS: Thanks to Helene and Ryan for the review üëçüèª.</p></article></main><div class="flex flex-wrap w-full items-center font-sans p-8 md:p-24"><div class="md:flex-1 flex"><img class="w-10 h-10 rounded-full mr-4" src="/Images/avatar.png" alt="Thibault Wittemberg"/><div class="flex-1"><p class="text-base font-bold text-base md:text-xl leading-none">Thibault Wittemberg</p><p class="text-gray-600 text-xs md:text-base">Mobile Solution Architect in Montreal üá®üá¶ (thibault.wittemberg@gmail.com)</p></div></div><div class="mt-8 md:mt-0 mx-auto md:mx-0 md:justify-end"><a class="bg-transparent border border-gray-500 hover:border-casper-blue text-xs text-gray-500 hover:text-casper-blue font-bold py-2 px-4 rounded-full" href="/tags">All tags</a></div></div></div></div><div class="bg-gray-200"><div class="container w-full max-w-6xl mx-auto px-2 py-8"><div class="grid grid-cols-1 sm:grid-cols-3 gap-12"><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2017-12-09-RxFlow-Part2" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2017-12-09-RxFlow-Part2/RxFlow_Logo.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">OPEN SOURCE, REACTIVE PROGRAMMING</p><div class="w-full font-bold text-2xl text-gray-900 px-6">RxFlow Part 2: In Practice</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">A few weeks ago I introduced in this blog an iOS framework called RxFlow. I‚Äôve been working on this framework for several months, and it is now ready to be used. If you haven‚Äôt read it yet, I suggest you take a look at this post "RxFlow Part1: In Theory".</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">11 MIN READ</p></div></div></div><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2019-06-18-PropertyWrappers" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2019-06-18-PropertyWrappers/wrapper.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">LANGUAGE</p><div class="w-full font-bold text-2xl text-gray-900 px-6">Property Wrappers In Swift 5.1, The Missing Published Implementation</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">It‚Äôs been an amazing WWDC this year. SwiftUI and Combine were some big announcements of the conference. They will have a huge impact on our daily life as iOS developers.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">6 MIN READ</p></div></div></div><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2020-08-19-FunctionsAsDependencies" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2020-08-19-FunctionsAsDependencies/header.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">ARCHITECTURE, FUNCTIONAL PROGRAMMING</p><div class="w-full font-bold text-2xl text-gray-900 px-6">Functions as dependencies in Swift</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">Implementing an architecture within an application can be challenging. There are rules we can follow (SOLID, Clean Architecture) and patterns to guide us (MVVM, MVP, MVI, Redux, ‚Ä¶) but sometimes, things we thought were well established deserve a step back.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">14 MIN READ</p></div></div></div></div></div></div><footer class="bg-gray-900"><div class="container max-w-6xl mx-auto flex items-center px-2 pt-2 pb-8"><div class="w-full mx-auto flex flex-wrap items-center"><div class="flex w-full md:w-1/2 justify-center md:justify-start text-white font-extrabold"><p><a class="text-gray-900 no-underline hover:text-gray-900 hover:no-underline" href="#"><span class="text-base text-gray-200">Warp your mobile development</span></a></p></div><div class="flex w-full pt-2 content-center justify-between md:w-1/2 md:justify-end"><ul class="list-reset flex justify-center flex-1 md:flex-none items-center"><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="/">Latest Posts</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="https://github.com/JohnSundell/Publish">Publish</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="https://ghost.org">Ghost</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline px-3 text-sm" href="/feed.rss"><svg class="fill-current h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"></circle><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"></path></svg></a></li></ul></div></div></div></footer></body></html>