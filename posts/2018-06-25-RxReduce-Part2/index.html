<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Warp your mobile development"/><link rel="canonical" href="http://blog.warpfactor.io/posts/2018-06-25-RxReduce-Part2"/><meta name="twitter:url" content="http://blog.warpfactor.io/posts/2018-06-25-RxReduce-Part2"/><meta name="og:url" content="http://blog.warpfactor.io/posts/2018-06-25-RxReduce-Part2"/><title>RxReduce: Reactive State Container Architecture Part 2 | Warp your mobile development</title><meta name="twitter:title" content="RxReduce: Reactive State Container Architecture Part 2 | Warp your mobile development"/><meta name="og:title" content="RxReduce: Reactive State Container Architecture Part 2 | Warp your mobile development"/><meta name="description" content="As we saw in ‚ÄúRxReduce: A Reactive State Container Architecture Part 1‚Äù, State is a central concern in applications. I strongly invite you to take a look at this first article. So far, we haven‚Äôt introduced the concept of Reactive Programming and how it can address some issues I‚Äôve encountered in traditional implementations of State Containers. We will see how RxReduce, an open source framework of the RxSwiftCommunity, can help you handle the State, its mutations, and the asynchronous work related to the side effects, in a Reactive way."/><meta name="twitter:description" content="As we saw in ‚ÄúRxReduce: A Reactive State Container Architecture Part 1‚Äù, State is a central concern in applications. I strongly invite you to take a look at this first article. So far, we haven‚Äôt introduced the concept of Reactive Programming and how it can address some issues I‚Äôve encountered in traditional implementations of State Containers. We will see how RxReduce, an open source framework of the RxSwiftCommunity, can help you handle the State, its mutations, and the asynchronous work related to the side effects, in a Reactive way."/><meta name="og:description" content="As we saw in ‚ÄúRxReduce: A Reactive State Container Architecture Part 1‚Äù, State is a central concern in applications. I strongly invite you to take a look at this first article. So far, we haven‚Äôt introduced the concept of Reactive Programming and how it can address some issues I‚Äôve encountered in traditional implementations of State Containers. We will see how RxReduce, an open source framework of the RxSwiftCommunity, can help you handle the State, its mutations, and the asynchronous work related to the side effects, in a Reactive way."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Warp your mobile development"/></head><body class="bg-white font-sans leading-normal tracking-normal"><div class="pb-16"><nav class="fixed z-10 bg-gray-900 p-4 mt-0 w-full overflow-auto scrolling-touch"><div class="container mx-auto flex items-center"><div class="flex-shrink-0 text-white font-extrabold"><a class="flex text-white text-base no-underline hover:text-white hover:no-underline" href="/"><span class="block md:hidden md:w-auto pl-1">üçè</span><span class="hidden md:block w-0 md:w-auto pl-1">Warp your mobile development</span></a></div><div class=" flex flex-no-wrap pl-4 text-sm"><ul class="list-reset flex justify-between items-center"><li class="mr-2"><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-2" href="/">HOME</a></li><li><a class="inline-block py-2 px-2 text-white no-underline hover:underline whitespace-no-wrap" href="/posts">MY POSTS</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-2 whitespace-no-wrap" href="/rxflow">RXFLOW</a></li></ul></div></div></nav></div><div class="text-center pt-16 md:pt-32"><p class="text-xs md:text-sm text-casper-blue font-bold">25 JUIN 2018<span class="text-gray-900 px-1">/</span><a href="/tags/architecture">ARCHITECTURE</a>, <a href="/tags/reactive-programming">REACTIVE PROGRAMMING</a>, <a href="/tags/open-source">OPEN SOURCE</a></p><h1 class="font-bold break-normal text-3xl md:text-5xl max-w-6xl mx-auto">RxReduce: Reactive State Container Architecture Part 2</h1></div><div class="container w-full max-w-6xl h-48 md:h-cover mx-auto bg-white bg-cover bg-center mt-8 sm:rounded" style="background-color: #465059; background-image:url('/Images/2018-06-25-RxReduce-Part2/RxReduce_Logo.png');"></div><div class="container max-w-5xl mx-auto md:-mt-32"><div class="mx-0 sm:mx-6"><main class="bg-white w-full p-8 md:p-24 text-gray-800 leading-normal"><article class="prose prose-sm sm:prose-xl break-words"><p>As we saw in <a href="/posts/2018-06-24-RxReduce-Part1">RxReduce: A Reactive State Container Architecture Part 1</a>, <strong>State</strong> is a central concern in applications. I strongly invite you to take a look at this first article. So far, we haven't introduced the concept of Reactive Programming and how it can address some issues I've encountered in traditional implementations of <strong>State Containers</strong>. We will see how <a href="https://github.com/RxSwiftCommunity/RxReduce">RxReduce</a>, an open source framework of the RxSwiftCommunity, can help you handle the <strong>State</strong>, its mutations, and the asynchronous work related to the side effects, in a Reactive way.</p><h1>The concerns</h1><ul><li>Store uses the Observer pattern: One of the responsibilities of the <strong>Store</strong> is to propagate the <strong>State</strong> mutations to the rest of the application. To do so, it is common to use an <strong>Observer</strong> pattern, so that observers will be notified of new <strong>State</strong> values. In a traditional approach, observers will register/unregister themselves to the <strong>Store</strong> which implies a lot of boilerplate code to deal with that.</li><li>Side effects: In <a href="/posts/2018-06-24-RxReduce-Part1">part 1</a> we saw that side effects (mostly asynchronous work) could not be handled by the <strong>Store/Reducers</strong>. It is a requisite for <strong>State</strong> reproducibility and testability. But as we all know, side effects are very usual and somehow mandatory in every applications. Using an architecture that only says "eh, you should do the side effects outside the state mutations" can be a little frustrating and annihilate the will to implement it.</li></ul><h1>RxReduce</h1><p><a href="https://github.com/RxSwiftCommunity/RxReduce">RxReduce</a> is born from my willing to test patterns like <a href="https://redux.js.org">Redux</a> in a native mobile application. I had a significant experience with MVC, MVP and MVVM, but I was curious about <strong>State</strong> management.&nbsp;</p><p><strong>State</strong> is obviously something I already had to deal with in more traditional architectures. I ended up, having low level layers, such as "<strong>services</strong>" layers, exposing my <strong>Model</strong> via RxSwift Observables. It was a good start, but Model is not truly a state and it was spread all across my services: not ideal to guarantee a global consistency.</p><p>I had to go further in my understanding of <strong>State</strong> management but with the aim to address the previous concerns about the Observer pattern and the side effects.&nbsp;</p><p><a href="https://github.com/RxSwiftCommunity/RxReduce"><strong>RxReduce</strong></a>:</p><ul><li>provides a generic <strong>Store</strong> that can handle all kinds of <strong>States.</strong></li><li>exposes <strong>State</strong> mutations through a Reactive mechanism.</li><li>provides a simple/unified way to mutate the <strong>State</strong> synchronously and asynchronously via <strong>Actions.</strong></li></ul><p>In the rest of this article, I assume you are familiar with the basics of Reactive Programming in general, and RxSwift in particular. If you are not, there are plenty of great ressources on the web üëå.</p><h2>RxReduce terminology</h2><p>You can browse the repo here:&nbsp;<a href="https://github.com/RxSwiftCommunity/RxReduce">https://github.com/RxSwiftCommunity/RxReduce</a>.</p><p><strong>RxReduce</strong> is compatible with CocoaPods and Carthage. It is a very tiny library consisting in three protocols, one class and two typealiases:</p><ul><li><strong>StoreType</strong>: a protocol describing what should be a <strong>Store</strong>. Although it is a public protocol, you shouldn't need to implement your own as RxReduce provides a default <strong>Store</strong>.</li><li><strong>State</strong>: an empty protocol used to identify a <strong>State</strong> in the <strong>Store</strong>, nothing special to implement here.</li><li><strong>Action</strong>: a protocol used to identify an <strong>Action</strong> in the dispatch function of a <strong>Store</strong>. A single function is to be implemented: "toAsync()", but RxReduce provides default implementations for that, nothing special to do here (explanations to come later in the "Conditional Conformance is magic" chapter).&nbsp;&nbsp;</li><li><strong>Store</strong>: a class representing a default <strong>Store</strong> capable of dispatching synchronous or asynchronous <strong>Actions</strong> inside <strong>Reducers</strong> and <strong>Middlewares</strong>. A <strong>Store</strong> exposes the mutated <strong>State</strong>. You can have several <strong>Stores</strong> in your app, each one taking care of a dedicated <strong>State</strong>, but you should consider dealing with a unique <strong>Store</strong> for the sake of simplicity and <strong>State</strong> tracking.</li><li><strong>Reducer</strong>: a typealias for a pure generic function taking an <strong>Action</strong>, a <strong>State</strong> and returning a new <strong>State</strong>. You will have to provide at least one <strong>Reducer</strong> in the <strong>Store</strong> initialization. Of course it is also possible to add several <strong>Reducers</strong> so you can separate responsibilities. <strong>Reducers</strong> are applied in sequence when dispatching an <strong>Action</strong> to the <strong>Store</strong>.</li><li><strong>Middleware</strong>: a typealias for a pure generic function taking an <strong>Action</strong>, a <strong>State</strong> and returning ‚Ä¶ nothing. Basically you can see it as a <strong>Reducer</strong> having no mutation powers. It will be called before <strong>Reducers</strong> when dispatching an <strong>Action</strong> to the <strong>Store</strong>. <strong>Middlewares</strong> are useful for logging purposes for instance.</li></ul><h2>State drives your UI</h2><blockquote><p>State is the heart of your application, by definition ! (<a href="/posts/2018-06-24-RxReduce-Part1">RxReduce: A Reactive State Container Architecture Part 1</a>)</p></blockquote><p>An application is just the reflection of a <strong>State</strong> at a given time. Regarding that, the title of this chapter is not a coincidence.</p><p>Using a <strong>RxSwift Driver</strong> is the way RxReduce exposes the <strong>State</strong> mutations to the outside world, particularly to the UI. As a reminder, a <strong>Driver</strong> is an Observable that cannot fail and only emits events on the main Thread, it makes sense for a <strong>State</strong>.</p><p>Listening to the <strong>State</strong> mutations raises some fundamental questions:</p><ul><li>what if I don't want to be notified by a <strong>State</strong> mutation that happens on a part of the <strong>State</strong> I'm not interested in ?</li><li>what if the <strong>State</strong> is replaced by a new value that is strictly equal ? Will the notification mechanism trigger unnecessary UI updates ?</li></ul><p>That deserves a little explanation üòÄ. Let's say our <strong>State</strong> is a <strong>struct</strong> representing:</p><ul><li>the current user of the application.</li><li>the list of the user's contacts.</li></ul><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">User</span><span class="p">:</span> <span class="nb">Equatable</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">firstName</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">let</span> <span class="nv">lastName</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Contact</span><span class="p">:</span> <span class="nb">Equatable</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">user</span><span class="p">:</span> <span class="n">User</span>
    <span class="kd">let</span> <span class="nv">isConnected</span><span class="p">:</span> <span class="n">Boolean</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="nc">UserState</span><span class="p">:</span> <span class="nb">Equatable</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">empty</span>
    <span class="k">case</span> <span class="n">loaded</span> <span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="nc">ContactsState</span><span class="p">:</span> <span class="nb">Equatable</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">empty</span>
    <span class="k">case</span> <span class="n">loaded</span> <span class="p">([</span><span class="n">Contact</span><span class="p">])</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">AppState</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="nb">Equatable</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">userState</span><span class="p">:</span> <span class="n">UserState</span>
    <span class="kd">var</span> <span class="nv">contactsState</span><span class="p">:</span> <span class="n">ContactsState</span>
<span class="p">}</span>
</div></code></pre><p>As you can see, those types are "<strong>value types</strong>", it is a requirement to guarantee <strong>State</strong> immutability and consistency. They are also "<strong>Equatable</strong>". It will allow RxReduce to know if two successives <strong>States</strong> are the same or not, avoiding unnecessary notifications. That's an answer to one of our concerns üëç.</p><p><strong>AppState</strong>&nbsp;also conforms to "<strong>State</strong>". It is a requirement to be handled by the <strong>Store</strong>.</p><p>The following "<strong>dispatch()</strong>" function belongs to the default&nbsp;<strong>Store</strong>&nbsp;provided by <strong>RxReduce</strong>:</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">func</span> <span class="nf">dispatch</span> <span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">Action</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// every received action is converted to an async action</span>
    <span class="n">action</span>
        <span class="p">.</span><span class="n">toAsync</span><span class="p">()</span>
        <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="p">[</span><span class="kr">unowned</span> <span class="kc">self</span><span class="p">]</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">StateType</span><span class="p">?</span> <span class="k">in</span>
            <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">reducers</span><span class="p">.</span><span class="bp">reduce</span><span class="p">(</span><span class="kc">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reducer</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">StateType</span><span class="p">?</span> <span class="k">in</span>
                <span class="k">return</span> <span class="n">reducer</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="kr">unowned</span> <span class="kc">self</span><span class="p">]</span> <span class="p">(</span><span class="n">newState</span><span class="p">)</span> <span class="k">in</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">newState</span><span class="p">)</span>
        <span class="p">}).</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">disposeBag</span><span class="p">)</span>
<span class="p">}</span>
</div></code></pre><p>Each time the <strong>Store</strong> receives an <strong>Action</strong>:</p><ul><li>the <strong>Action</strong> is transformed in an asynchronous one (see the "Conditional Conformance is magic" chapter).</li><li>the list of the registered <strong>Reducers</strong> is applied to the <strong>State</strong>.</li><li>the new <strong>State</strong> replaces the old one.</li></ul><p>Let's see two examples of Actions:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">LoadUserAction</span><span class="p">:</span> <span class="n">Action</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">firstname</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">let</span> <span class="nv">lastname</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">LoadContactsAction</span><span class="p">:</span> <span class="n">Action</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">contacts</span><span class="p">:</span> <span class="p">[</span><span class="n">Contact</span><span class="p">]</span>
<span class="p">}</span>
</div></code></pre><p>No rocket science here ‚Ä¶ <strong>Actions</strong> just embed what's needed to mutate the <strong>State</strong>, no business logic.</p><p>Here are two examples of <strong>Reducers</strong>:</p><pre><code><div class="highlight"><span></span><span class="kd">func</span> <span class="nf">userReducer</span> <span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AppState</span><span class="p">?,</span> <span class="n">action</span><span class="p">:</span> <span class="n">Action</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">AppState</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nv">currentState</span> <span class="p">=</span> <span class="n">state</span> <span class="p">??</span> <span class="n">AppState</span><span class="p">(</span><span class="n">userState</span><span class="p">:</span> <span class="n">UserState</span><span class="p">.</span><span class="n">empty</span><span class="p">,</span>
                                         <span class="n">contactsState</span><span class="p">:</span> <span class="n">ContactsState</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>

    <span class="c1">// according to the action we create a new state</span>
    <span class="k">switch</span> <span class="n">action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kd">let</span> <span class="nv">action</span> <span class="k">as</span> <span class="n">LoadUserAction</span><span class="p">:</span>
        <span class="n">currentState</span><span class="p">.</span><span class="n">userState</span> <span class="p">=</span> <span class="n">UserState</span><span class="p">.</span><span class="n">loaded</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">firstname</span><span class="p">:</span> <span class="n">action</span><span class="p">.</span><span class="n">firstname</span><span class="p">,</span>
                                                       <span class="n">lastname</span><span class="p">:</span> <span class="n">action</span><span class="p">.</span><span class="n">lastname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">currentState</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">currentState</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">contactsReducer</span> <span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AppState</span><span class="p">?,</span> <span class="n">action</span><span class="p">:</span> <span class="n">Action</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">AppState</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nv">currentState</span> <span class="p">=</span> <span class="n">state</span> <span class="p">??</span> <span class="n">AppState</span><span class="p">(</span><span class="n">userState</span><span class="p">:</span> <span class="n">UserState</span><span class="p">.</span><span class="n">empty</span><span class="p">,</span>
                                         <span class="n">contactsState</span><span class="p">:</span> <span class="n">ContactsState</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>

    <span class="c1">// according to the action we create a new state</span>
    <span class="k">switch</span> <span class="n">action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kd">let</span> <span class="nv">action</span> <span class="k">as</span> <span class="n">LoadContactsAction</span><span class="p">:</span>
        <span class="n">currentState</span><span class="p">.</span><span class="n">contactsState</span> <span class="p">=</span> <span class="n">ContactsState</span><span class="p">.</span><span class="n">loaded</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">contacts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">currentState</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">currentState</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>Each <strong>Reducer</strong> handles the <strong>Actions</strong> it cares about. It allows to split the <strong>State</strong> mutations into logical units.</p><h2>Need to focus on your state ? Use Lenses !</h2><p><strong>Lenses</strong> is a technic from the functional programming that will address the remaining issue: "<strong>what if I don't want to be notified by a State mutation that happens on a part I'm not interested in ?</strong>"</p><p>A few resources about <strong>Lenses</strong>:</p><ul><li><a href="http://chris.eidhof.nl/post/lenses-in-swift/">Lenses in Swift by Chris Eidhof</a>.</li><li><a href="https://broomburgo.github.io/fun-ios/post/lenses-and-prisms-in-swift-a-pragmatic-approach/">Lenses and Prisms in Swift by Elviro Rocca</a>.</li></ul><p>In a few words, Lenses allow you to focus on a sub-part of a value type. Being a functional programming technic, it uses a function to do so. Let's try this on our model:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">Lens</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">from</span> <span class="p">:</span> <span class="n">A</span> <span class="p">-&gt;</span> <span class="n">B</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">firstname</span> <span class="p">=</span> <span class="n">Lens</span><span class="p">&lt;</span><span class="n">Contact</span><span class="p">,</span> <span class="nb">String</span><span class="p">&gt;(</span><span class="n">from</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">firstname</span> <span class="p">})</span>

<span class="p">...</span>

<span class="kd">let</span> <span class="nv">myContact</span> <span class="p">=</span> <span class="n">Contact</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">(</span><span class="n">firstname</span><span class="p">:</span> <span class="s">&quot;James&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="p">:</span> <span class="s">&quot;Kirk&quot;</span><span class="p">),</span>
                        <span class="n">isConnected</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>

<span class="n">firstname</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">myContact</span><span class="p">)</span> <span class="c1">// will return &quot;James&quot;</span>
</div></code></pre><p>RxReduce uses the very same technic to expose a <strong>State</strong> in a <strong>Store</strong>. You just have to call the "<strong>state()</strong>" function with the closure that focuses on the sub-State you want to listen to:</p><pre><code><div class="highlight"><span></span><span class="kd">func</span> <span class="nf">state</span><span class="p">&lt;</span><span class="n">SubState</span><span class="p">:</span> <span class="nb">Equatable</span><span class="p">&gt;(</span><span class="n">from</span><span class="p">:</span> <span class="p">(</span><span class="n">StateType</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">SubState</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Driver</span><span class="p">&lt;</span><span class="n">SubState</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">stateSubject</span>
        <span class="p">.</span><span class="n">asDriver</span><span class="p">()</span>
        <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">SubStateType</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">from</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="p">}.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
<span class="p">}</span>
</div></code></pre><p>This function addresses our two issues:</p><ul><li>it does not trigger a new event if two consecutives <strong>States</strong> are equal (thanks to "<strong>distinctUntilChanged()</strong>").</li><li>it allows to not listen to the whole <strong>State</strong>.</li></ul><p>Of course, you noticed the <strong>State</strong> is exposed via a <strong>Driver</strong> üòÄüëå (remember: <strong>State drives your UI</strong>).</p><p>For the record, <strong>RxReduce</strong> also provides an implementation of this function without parameters, you will get a <strong>Driver</strong> for the whole <strong>State</strong>.</p><p>A typical workflow with RxReduce would look like that:</p><pre><code><div class="highlight"><span></span><span class="c1">// init the Store with the list of the Reducers to apply</span>
<span class="kd">let</span> <span class="nv">store</span> <span class="p">=</span> <span class="n">Store</span><span class="p">&lt;</span><span class="n">AppState</span><span class="p">&gt;(</span><span class="n">withReducers</span><span class="p">:</span> <span class="p">[</span><span class="n">userReducer</span><span class="p">,</span> <span class="n">contactsReducer</span><span class="p">])</span>

<span class="p">...</span>

<span class="c1">// listen for the UserState mutations</span>
<span class="kd">let</span> <span class="nv">userState</span><span class="p">:</span> <span class="n">Driver</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">state</span> <span class="p">{</span> <span class="p">(</span><span class="n">appState</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">UserState</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">appState</span><span class="p">.</span><span class="n">userState</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="c1">// react to the UserState mutations</span>
<span class="n">userState</span><span class="p">.</span><span class="n">drive</span><span class="p">(</span><span class="n">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">userState</span><span class="p">)</span> <span class="k">in</span>
    <span class="bp">print</span> <span class="p">(</span><span class="s">&quot;New userState is </span><span class="si">\(</span><span class="n">userState</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="c1">// update the UI in a Thread safe way</span>
    <span class="p">...</span>
<span class="p">}).</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">disposeBag</span><span class="p">)</span>

<span class="p">...</span>

<span class="c1">// ask the Store to mutate the State</span>
<span class="n">store</span><span class="p">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">LoadUserAction</span><span class="p">(</span><span class="n">firstname</span><span class="p">:</span> <span class="s">&quot;Tony&quot;</span><span class="p">,</span> <span class="n">lastname</span><span class="p">:</span> <span class="s">&quot;Stark&quot;</span><span class="p">))</span>
</div></code></pre><h2>Conditional Conformance is magic</h2><p>There is one concern left to address ‚Ä¶ side effects.</p><p>In functional programming, side effects are all the things that can mutate a <strong>State</strong> using I/O. It can be networking, persistence, file access, ‚Ä¶ Having side effects, a function can be unpredictable depending on the state of the system. When a function has no side effect, we can execute it anytime, it will always return the same result, given the same input.</p><p>In unidirectional data flow architectures, we will try to isolate side effects out of the golden path: <strong>View -&gt; Action -&gt; Store -&gt; Reducer -&gt; State -&gt; View</strong>.</p><p>Redux has a solution for that: <strong>Action Creators</strong>. It is something that will emit an <strong>Action</strong> and dispatch it to the <strong>Store</strong> once an asynchronous job is finished.</p><p>Hum, it looks familiar to me ‚Ä¶ wouldn't be exactly what an Observable&lt;<strong>Action</strong>&gt; is in RxSwift ? Does it mean that the <strong>Store</strong>'s "<strong>dispatch()</strong>" function should not take an <strong>Action</strong> as a parameter but an Observable&lt;<strong>Action</strong>&gt; ?</p><p>Well ‚Ä¶ yes and no ! In fact it can take both, because sometimes we want synchronous mutation and sometimes asynchronous mutation.</p><p>He who can most can least. A synchronous job is just an asynchronous job that ends at job start üëç. RxReduce provides a way to convert a synchronous action to an asynchronous one:</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Action</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">toAsync</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">Action</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">toAsync</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;.</span><span class="n">just</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>Very easy. If you remember the implementation of the "<strong>dispatch()</strong>" function, the first thing it does is calling "<strong>action.toAsync()</strong>" ‚Ä¶ now you have the explanation.</p><p>It's great but that's only one part of the solution, it allows the <strong>Store</strong> to dispatch synchronous actions as they were asynchronous. What about truly asynchronous actions ?</p><p>Lately, Swift 4.1 has introduced conditional conformance. If you are not familiar with this concept: <a href="/posts/2018-04-02-GlanceAtConditionalConformance">A Glance at conditional conformance</a>.</p><p>Basically it allows to make a generic type conform to a protocol only if the associated inner type also conforms to this protocol. Let's apply this to Observable:</p><pre><code><div class="highlight"><span></span><span class="kd">extension</span> <span class="nc">Observable</span><span class="p">:</span> <span class="n">Action</span> <span class="k">where</span> <span class="n">Element</span> <span class="p">==</span> <span class="n">Action</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">toAsync</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">as</span> <span class="n">Action</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>It means that an Observable&lt;<strong>Action</strong>&gt; is also in <strong>Action</strong>, only if the Element is itself an <strong>Action</strong>. Pretty neat.</p><p>The Store will dispatch an <strong>Action</strong> whether it is synchronous or asynchronous ‚Ä¶ seamlessly.</p><p>In fact, loading a User would look like that:</p><pre><code><div class="highlight"><span></span><span class="kd">let</span> <span class="nv">loadUserAction</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">UserApi</span><span class="p">.</span><span class="n">fetchUser</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">).</span><span class="bp">map</span> <span class="p">{</span> <span class="n">user</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">LoadUserAction</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">store</span><span class="p">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">loadUserAction</span><span class="p">)</span>
</div></code></pre><p>Conditional Conformance is a very powerful feature, and no need for Action Creators at all üòÄ.</p><h2>Demo application</h2><p>You will find a complete <a href="https://github.com/RxSwiftCommunity/RxReduce/tree/master/RxReduceDemo">Demo application</a> in the RxReduce repo. It uses a combination of MVVM and State Container.</p><h2>Conclusion</h2><p>I think <strong>State Container Architectures</strong> are a great contribution to the mobile software engineering. It forces to ask yourself what should be the <strong>State</strong> of your application, how to mutate it, how to isolate the I/Os. It is a truly good complement to traditional patterns that are only view oriented.</p><p>RxReduce leverages functional reactive programming to address issues that could repel you otherwise.</p><p>If you'd like to know more about RxReduce, feel free to visit the <a href="https://github.com/RxSwiftCommunity/RxReduce">GitHub repo</a> and contribute üëç.</p><p>I hope you enjoyed this topic.</p><p>Stay tuned.</p></article></main><div class="flex flex-wrap w-full items-center font-sans p-8 md:p-24"><div class="md:flex-1 flex"><img class="w-10 h-10 rounded-full mr-4" src="/Images/avatar.png" alt="Thibault Wittemberg"/><div class="flex-1"><p class="text-base font-bold text-base md:text-xl leading-none">Thibault Wittemberg</p><p class="text-gray-600 text-xs md:text-base">Mobile Solution Architect in Montreal üá®üá¶</p></div></div><div class="mt-8 md:mt-0 mx-auto md:mx-0 md:justify-end"><a class="bg-transparent border border-gray-500 hover:border-casper-blue text-xs text-gray-500 hover:text-casper-blue font-bold py-2 px-4 rounded-full" href="/tags">All tags</a></div></div></div></div><div class="bg-gray-200"><div class="container w-full max-w-6xl mx-auto px-2 py-8"><div class="grid grid-cols-1 sm:grid-cols-3 gap-12"><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2017-11-08-RxFlow-Part1" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2017-11-08-RxFlow-Part1/RxFlow_Logo.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">OPEN SOURCE, REACTIVE PROGRAMMING</p><div class="w-full font-bold text-2xl text-gray-900 px-6">RxFlow Part 1: In Theory</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">This is a first article in a series that will be the heart of this blog for a while. I‚Äôm going to introduce RxFlow: a framework of my design implementing Reactive Flow Coordinator within iOS applications. RxFlow relies on RxSwift and is a project supported by the RxSwiftCommunity.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">4 MIN READ</p></div></div></div><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2019-06-18-PropertyWrappers" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2019-06-18-PropertyWrappers/wrapper.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">LANGUAGE</p><div class="w-full font-bold text-2xl text-gray-900 px-6">Property Wrappers In Swift 5.1, the Missing Published Implementation</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">It‚Äôs been an amazing WWDC this year. SwiftUI and Combine were some big announcements of the conference. They will have a huge impact on our daily life as iOS developers.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">6 MIN READ</p></div></div></div><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2019-07-20-Swift-AOP" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2019-07-20-Swift-AOP/puzzle.jpg" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">LANGUAGE</p><div class="w-full font-bold text-2xl text-gray-900 px-6">Swift: An Aspect Oriented Programming Language ?</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">To answer this question, we must first understand what is Aspect Oriented Programming (aka AOP). I like to see AOP as a response to a certain kind of failure of Object Oriented conceptions.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">13 MIN READ</p></div></div></div></div></div></div><footer class="bg-gray-900"><div class="container max-w-6xl mx-auto flex items-center px-2 pt-2 pb-8"><div class="w-full mx-auto flex flex-wrap items-center"><div class="flex w-full md:w-1/2 justify-center md:justify-start text-white font-extrabold"><p><a class="text-gray-900 no-underline hover:text-gray-900 hover:no-underline" href="#"><span class="text-base text-gray-200">Warp your mobile development</span></a></p></div><div class="flex w-full pt-2 content-center justify-between md:w-1/2 md:justify-end"><ul class="list-reset flex justify-center flex-1 md:flex-none items-center"><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="/">Latest Posts</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="https://github.com/JohnSundell/Publish">Publish</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="https://ghost.org">Ghost</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline px-3 text-sm" href="/feed.rss"><svg class="fill-current h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"></circle><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"></path></svg></a></li></ul></div></div></div></footer></body></html>