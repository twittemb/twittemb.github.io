<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Warp your mobile development"/><link rel="canonical" href="http://blog.warpfactor.io/posts/2020-03-26-Spin"/><meta name="twitter:url" content="http://blog.warpfactor.io/posts/2020-03-26-Spin"/><meta name="og:url" content="http://blog.warpfactor.io/posts/2020-03-26-Spin"/><title>Introducing Spin | Warp your mobile development</title><meta name="twitter:title" content="Introducing Spin | Warp your mobile development"/><meta name="og:title" content="Introducing Spin | Warp your mobile development"/><meta name="description" content="Introducing Spin, a universal feedback loop system in Swift. A Feedback Loop is a system that is able to self-regulate by using the resulting value from its computations as the next input to itself, constantly adjusting this value according to given rules."/><meta name="twitter:description" content="Introducing Spin, a universal feedback loop system in Swift. A Feedback Loop is a system that is able to self-regulate by using the resulting value from its computations as the next input to itself, constantly adjusting this value according to given rules."/><meta name="og:description" content="Introducing Spin, a universal feedback loop system in Swift. A Feedback Loop is a system that is able to self-regulate by using the resulting value from its computations as the next input to itself, constantly adjusting this value according to given rules."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Warp your mobile development"/></head><head>                <!-- Global site tag (gtag.js) - Google Analytics -->
                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109460106-1"></script>
                <script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());

                  gtag('config', 'UA-109460106-1');
                </script></head><body class="bg-white font-sans leading-normal tracking-normal"><div class="pb-16"><nav class="fixed z-10 bg-gray-900 p-4 mt-0 w-full overflow-auto scrolling-touch"><div class="container mx-auto flex items-center"><div class="flex-shrink-0 text-white font-extrabold"><a class="flex text-white text-base no-underline hover:text-white hover:no-underline" href="/"><span class="block md:hidden md:w-auto pl-1">üçè</span><span class="hidden md:block w-0 md:w-auto pl-1">Warp your mobile development</span></a></div><div class=" flex flex-no-wrap pl-4 text-sm"><ul class="list-reset flex justify-between items-center"><li class="mr-2"><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-2" href="/">HOME</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-2 whitespace-no-wrap" href="/projects">PROJECTS</a></li><li><a class="inline-block py-2 px-2 text-white no-underline hover:underline whitespace-no-wrap" href="/posts">MY POSTS</a></li></ul></div></div></nav></div><div class="text-center pt-16 md:pt-32"><p class="text-xs md:text-sm text-casper-blue font-bold">26 MARCH 2020<span class="text-gray-900 px-1">/</span><a href="/tags/architecture">ARCHITECTURE</a>, <a href="/tags/reactive-programming">REACTIVE PROGRAMMING</a>, <a href="/tags/functional-programming">FUNCTIONAL PROGRAMMING</a>, <a href="/tags/open-source">OPEN SOURCE</a></p><h1 class="font-bold break-normal text-3xl md:text-5xl max-w-6xl mx-auto">Introducing Spin</h1></div><div class="container w-full max-w-6xl h-48 md:h-cover mx-auto bg-white bg-cover bg-center mt-8 sm:rounded" style="background-color: #465059; background-image:url('/Images/2020-03-26-Spin/header.jpeg');"></div><div class="container max-w-5xl mx-auto md:-mt-32"><div class="mx-0 sm:mx-6"><main class="bg-white w-full p-8 md:p-24 text-gray-800 leading-normal"><article class="prose prose-sm sm:prose-xl break-words"><h1>The need for architectural patterns in swift applications</h1><p>With the recent introduction of <a href="https://developer.apple.com/documentation/combine">Combine</a> and <a href="https://developer.apple.com/tutorials/swiftui/">SwiftUI</a>, we will face some transition periods in our code base. Our applications will use both Combine and a third-party reactive framework, or both UIKit/AppKit and SwiftUI. This makes it potentially difficult to guarantee a consistent architecture over time. It is potentially hard to know when these new technologies will be incorporated in our projects. Making the right choice of architecture from the start may greatly ease the future transition.</p><p>Traditional architectural patterns like <a href="https://en.wikipedia.org/wiki/Model‚Äìview‚Äìcontroller">MVC</a>, <a href="https://en.wikipedia.org/wiki/Model‚Äìview‚Äìpresenter">MVP</a>, or <a href="https://en.wikipedia.org/wiki/Model‚Äìview‚Äìviewmodel">MVVM</a> mostly take care of the UI layer. They won‚Äôt be of great help when it comes to mix the aforementioned technologies inside your app in a unified way. For instance, MVVM in a UIKit application will rely a lot on two-way binding technologies with reactive extensions like RxCocoa or ReactiveCocoa. This will become less true as you gradually introduce SwiftUI and Combine. Chances are great that you will then have several architectural paradigms in your app.</p><p><a href="https://www.objc.io/issues/13-architecture/viper/">VIPER</a> is a little bit more complete as it describes the routing mechanism between scenes and the separation between models (entities) and the business rules that manage them (interactor). This pattern enforces the principles of <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Clean Architecture</a> regarding separation of concerns and dependencies management. But, as well as the MVxx patterns, it does not guarantee a consistency of syntax and paradigm over time when adopting Combine or SwiftUI gradually.</p><p>SwiftUI is about state as the single source of truth and reacting to that state mutations. This allows for views to be written in a declarative manner, not in a verbose and error prone imperative manner.</p><p>In recent years, several architectural patterns centred around the concept of State have emerged: things like <a href="https://redux.js.org">Redux</a> or MVI and more generally unidirectional data flow architectures. Sometimes they offer to manage the state in a central fashion, sometimes in a local way. Those are great patterns and they fit very well with the idea of a state as the single source of truth. I‚Äôm pretty sure they had a great influence in the making of SwiftUI.</p><p>I myself have implemented some of these patterns in production applications. They introduced me to functional programming as they rely on concepts such as immutability, pure functions, function composition, and so on. Functional programming and state management fit very well together. Functional programming is associated to data immutability, so should be the state.</p><p>Nevertheless, I experienced some drawbacks with these kind of architectures which led me to discover feedback loop systems.</p><h1>What is a feedback loop system ?</h1><p>A Feedback Loop is a system that is able to self-regulate by using the resulting value from its computations as the next input to itself, constantly adjusting this value according to given rules (Feedback Loops are used in domains like electronics to automatically adjust the level of a signal for instance).</p><img src="/Images/2020-03-26-Spin/1.png"/><blockquote><p>a feedback loop illustration</p></blockquote><p>Stated this way might sound obscur and unrelated to software engineering, <strong>BUT</strong> ‚Äúadjusting a value according to certain rules‚Äù is exactly what a program, and by extension an application, is made for! An application is the sum of all kinds of states that we want to regulate so as to provide a consistent behaviour following precise rules. The rules describing the allowed transitions from one value to another are described by a state machine.</p><h2>What is a State Machine?</h2><blockquote><p>It‚Äôs an abstract machine that can be in exactly one of a finite number of states at any given time. The state machine can change from one state to another in response to some external inputs. The change from one state to another is called a transition. A state machine is defined by a list of its states, its initial state, and the conditions for each transition.</p></blockquote><p>As an application is a state machine, it can be driven by a feedback loop system. A Feedback Loop is based on three components: an initial state, a feedback, and a reducer. To illustrate each one of them, we will rely on a basic example: a system that counts from 0 to 10:</p><ul><li>The initial state: this is the starting value of our counter, 0.</li><li>A feedback: this is the rule we apply to the counter to accomplish our purpose. The output of a feedback is a request to mutate the counter. If 0 &le; counter &lt;10 then we ask to increase it else we ask to stop it.</li><li>A reducer: this is the state machine of our system. It describes all the possible transitions of our counter given its previous value and the request computed by the feedback. For instance: if the previous value was 0 and the request is to increase it, then the new value is 1; if the previous was 1 and the request is to increase it, then the new value is 2; and so on and so on. When the request from the feedback is to stop, then the previous value is returned as the new value.</li></ul><img src="/Images/2020-03-26-Spin/2.png"/><blockquote><p>a feedback loop counting from 0 to 10</p></blockquote><p>Feedbacks are the only place where you can perform side effects (networking, local I/O, UI rendering, whatever you do that accesses or mutates a state outside the local scope of the loop). Conversely, a reducer is a pure function that can only produce a new value given a previous one and a transition request. Performing side effects in reducers is forbidden as it would compromise its reproducibility.</p><h1>The drawbacks of traditional unidirectional data flow architectures</h1><p>As you can see, the particularity of the feedback loop paradigm is that the state is both an input and an output, both connected as a whole to form a unidirectional loop. We can use the state as a local cache to persist data as long as the loop is alive and running.</p><p>A typical use case would be the browsing of a paginated API. This kind of system allows for the use of the current state to always make the previous page URL and the next page URL accessible which makes irrelevant the need to store it elsewhere. In more traditional unidirectional data flow architectures, the state is only the output of the system. The inputs are ‚Äúuser intents‚Äù that trigger side effects and then state mutations.</p><img src="/Images/2020-03-26-Spin/3.png"/><blockquote><p>unidirectional data flow</p></blockquote><p>I‚Äôve experienced several versions of these kinds of architectures (Redux and MVI) and found myself stuck with 2 majors issues: <em> Not having the state as an input can lead to maintaining a local state in the UI layer, or in a cache repository. </em> Relying on input such as Intents or Actions, which are often enums, forces us to parse them with <code>switch</code> statements to determine the side effect to execute. As we add new intents or new actions we have to change the way we parse them, going against the Open/Close principle of the SOLID rules.</p><p>I‚Äôm not saying these issues are a ‚Äúno-go‚Äù to use these architectures, nor am I saying I‚Äôve used them the best possible way. For instance, I‚Äôve worked on a variation of MVI where intents were replaced by a ‚Äúcommand pattern‚Äù. Each command was responsible for its own side effect execution. There was no parsing, the command was self-sufficient. This approach is compliant with the Open/Close principle as adding a new feature is about adding a new command to execute; and not modifying the way intents or actions are parsed.</p><p>But rather than twisting those architectures to accommodate my needs, I vote for an approach that naturally addresses these issues: feedback loop systems.</p><h1>What is Spin ?</h1><p>Let‚Äôs get back to our main concern: provide an architectural pattern that can absorb the divergence of technologies we can expect in our applications.</p><p>As we saw, feedback loop is a pretty versatile pattern. It will help us mitigate the issue with mixed technologies. But we need a way to declare feedback loops in a unified way regardless of the underlying reactive framework or the chosen UI technology. This is where Spin comes into play.</p><p><strong><a href="https://github.com/Spinners/Spin.Swift">Spin</a> is a tool to build feedback loops within a Swift based application allowing you to use a unified syntax whatever the underlying reactive programming framework and whatever Apple UI technology you use (RxSwift, ReactiveSwift, Combine and UIKit, AppKit, SwiftUI).</strong></p><p>Let‚Äôs try Spin by building a system that regulates two integers to make them converge to their average value (like some kind of system that would adjust a left and a right audio channel on stereo speakers to make them converge to the same level). We will need a data type for our state:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">Levels</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">left</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">let</span> <span class="nv">right</span><span class="p">:</span> <span class="nb">Int</span>
<span class="p">}</span>
</div></code></pre><p>We will also need a data type to describe the transitions to perform on Levels:</p><pre><code><div class="highlight"><span></span><span class="kd">enum</span> <span class="nc">Event</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">increaseLeft</span>
    <span class="k">case</span> <span class="n">decreaseLeft</span> 
    <span class="k">case</span> <span class="n">increaseRight</span>
    <span class="k">case</span> <span class="n">decreaseRight</span>
<span class="p">}</span>
</div></code></pre><p>In order to describe the state machine ruling the transitions, we need a reducer function:</p><pre><code><div class="highlight"><span></span><span class="kd">func</span> <span class="nf">levelsReducer</span><span class="p">(</span><span class="n">currentLevels</span><span class="p">:</span> <span class="n">Levels</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Levels</span> <span class="p">{</span>

    <span class="k">guard</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">!=</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">right</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">currentLevels</span> <span class="p">}</span>

    <span class="k">switch</span> <span class="n">event</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">decreaseLeft</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Levels</span><span class="p">(</span><span class="kr">left</span><span class="p">:</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">left</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kr">right</span><span class="p">:</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">right</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">increaseLeft</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Levels</span><span class="p">(</span><span class="kr">left</span><span class="p">:</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">left</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kr">right</span><span class="p">:</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">right</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">decreaseRight</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Levels</span><span class="p">(</span><span class="kr">left</span><span class="p">:</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">left</span><span class="p">,</span> <span class="kr">right</span><span class="p">:</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">right</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">increaseRight</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Levels</span><span class="p">(</span><span class="kr">left</span><span class="p">:</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">left</span><span class="p">,</span> <span class="kr">right</span><span class="p">:</span> <span class="n">currentLevels</span><span class="p">.</span><span class="kr">right</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>So far the code is not related to a specific reactive framework, which is great. Let‚Äôs write the two feedbacks that will have an effect on each level.</p><p>With RxSwift:</p><pre><code><div class="highlight"><span></span><span class="kd">func</span> <span class="nf">leftEffect</span><span class="p">(</span><span class="n">inputLevels</span><span class="p">:</span> <span class="n">Levels</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Event</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">// this is the stop condition to our Spin</span>
    <span class="k">guard</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">!=</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">}</span>

    <span class="c1">// this is the regulation for the left level</span>
    <span class="k">if</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">&lt;</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">.</span><span class="n">just</span><span class="p">(.</span><span class="n">increaseLeft</span><span class="p">)</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">.</span><span class="n">just</span><span class="p">(.</span><span class="n">decreaseLeft</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">rightEffect</span><span class="p">(</span><span class="n">inputLevels</span><span class="p">:</span> <span class="n">Levels</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Event</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">// this is the stop condition to our Spin</span>
    <span class="k">guard</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">!=</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">}</span>

    <span class="c1">// this is the regulation for the right level</span>
    <span class="k">if</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="o">&lt;</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">.</span><span class="n">just</span><span class="p">(.</span><span class="n">increaseRight</span><span class="p">)</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">.</span><span class="n">just</span><span class="p">(.</span><span class="n">decreaseRight</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>With ReactiveSwift:</p><pre><code><div class="highlight"><span></span><span class="kd">func</span> <span class="nf">leftEffect</span><span class="p">(</span><span class="n">inputLevels</span><span class="p">:</span> <span class="n">Levels</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">SignalProducer</span><span class="p">&lt;</span><span class="n">Event</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">// this is the stop condition to our Spin</span>
    <span class="k">guard</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">!=</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">.</span><span class="n">empty</span> <span class="p">}</span>

    <span class="c1">// this is the regulation for the left level</span>
    <span class="k">if</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">&lt;</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">SignalProducer</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="p">.</span><span class="n">increaseLeft</span><span class="p">)</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">SignalProducer</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="p">.</span><span class="n">decreaseLeft</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">rightEffect</span><span class="p">(</span><span class="n">inputLevels</span><span class="p">:</span> <span class="n">Levels</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">SignalProducer</span><span class="p">&lt;</span><span class="n">Event</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">// this is the stop condition to our Spin</span>
    <span class="k">guard</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">!=</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">.</span><span class="n">empty</span> <span class="p">}</span>

    <span class="c1">// this is the regulation for the right level</span>
    <span class="k">if</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="o">&lt;</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">SignalProducer</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="p">.</span><span class="n">increaseRight</span><span class="p">)</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">SignalProducer</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="p">.</span><span class="n">decreaseRight</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>With Combine:</p><pre><code><div class="highlight"><span></span><span class="kd">func</span> <span class="nf">leftEffect</span><span class="p">(</span><span class="n">inputLevels</span><span class="p">:</span> <span class="n">Levels</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">AnyPublisher</span><span class="p">&lt;</span><span class="n">Event</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">// this is the stop condition to our Spin</span>
    <span class="k">guard</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">!=</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Empty</span><span class="p">().</span><span class="n">eraseToAnyPublisher</span><span class="p">()</span> <span class="p">}</span>

    <span class="c1">// this is the regulation for the left level</span>
    <span class="k">if</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">&lt;</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Just</span><span class="p">(.</span><span class="n">increaseLeft</span><span class="p">).</span><span class="n">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Just</span><span class="p">(.</span><span class="n">decreaseLeft</span><span class="p">).</span><span class="n">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">rightEffect</span><span class="p">(</span><span class="n">inputLevels</span><span class="p">:</span> <span class="n">Levels</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">AnyPublisher</span><span class="p">&lt;</span><span class="n">Event</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">// this is the stop condition to our Spin</span>
    <span class="k">guard</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="o">!=</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Empty</span><span class="p">().</span><span class="n">eraseToAnyPublisher</span><span class="p">()</span> <span class="p">}</span>

    <span class="c1">// this is the regulation for the right level</span>
    <span class="k">if</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">right</span> <span class="o">&lt;</span> <span class="n">inputLevels</span><span class="p">.</span><span class="kr">left</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Just</span><span class="p">(.</span><span class="n">increaseRight</span><span class="p">).</span><span class="n">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Just</span><span class="p">(.</span><span class="n">decreaseRight</span><span class="p">).</span><span class="n">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>No matter the reactive technology you choose, writing a feedback loop (also called Spin) is as simple as that:</p><pre><code><div class="highlight"><span></span><span class="kd">let</span> <span class="nv">levelsSpin</span> <span class="p">=</span> <span class="n">Spinner</span>
<span class="p">.</span><span class="n">initialState</span><span class="p">(</span><span class="n">Levels</span><span class="p">(</span><span class="kr">left</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="kr">right</span><span class="p">:</span> <span class="mi">20</span><span class="p">))</span>
<span class="p">.</span><span class="n">feedback</span><span class="p">(</span><span class="n">Feedback</span><span class="p">(</span><span class="n">effect</span><span class="p">:</span> <span class="n">leftEffect</span><span class="p">))</span>
<span class="p">.</span><span class="n">feedback</span><span class="p">(</span><span class="n">Feedback</span><span class="p">(</span><span class="n">effect</span><span class="p">:</span> <span class="n">rightEffect</span><span class="p">))</span>
<span class="p">.</span><span class="n">reducer</span><span class="p">(</span><span class="n">Reducer</span><span class="p">(</span><span class="n">levelsReducer</span><span class="p">))</span>
</div></code></pre><p>That‚Äôs it. You can use RxSwift in a portion of your app and Combine in another one, and all the feedback loops will use the same syntax.</p><p>For ‚ÄúDSL-like‚Äù syntax lovers, there is a more declarative way:</p><pre><code><div class="highlight"><span></span><span class="kd">let</span> <span class="nv">levelsSpin</span> <span class="p">=</span> <span class="n">Spin</span><span class="p">(</span><span class="n">initialState</span><span class="p">:</span> <span class="n">Levels</span><span class="p">(</span><span class="kr">left</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="kr">right</span><span class="p">:</span> <span class="mi">20</span><span class="p">),</span> <span class="n">reducer</span><span class="p">:</span> <span class="n">Reducer</span><span class="p">(</span><span class="n">levelsReducer</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Feedback</span><span class="p">(</span><span class="n">effect</span><span class="p">:</span> <span class="n">leftEffect</span><span class="p">)</span>
    <span class="n">Feedback</span><span class="p">(</span><span class="n">effect</span><span class="p">:</span> <span class="n">rightEffect</span><span class="p">)</span>
<span class="p">}</span>
</div></code></pre><p>How to start the loop ?</p><pre><code><div class="highlight"><span></span><span class="c1">// With RxSwift</span>
<span class="n">Observable</span>
    <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">spin</span><span class="p">:</span> <span class="n">levelsSpin</span><span class="p">)</span>
    <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

<span class="c1">// With ReactiveSwift</span>
<span class="n">SignalProducer</span>
    <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">spin</span><span class="p">:</span> <span class="n">levelsSpin</span><span class="p">)</span>
    <span class="p">.</span><span class="n">disposed</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

<span class="c1">// With Combine</span>
<span class="n">AnyPublisher</span>
    <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">spin</span><span class="p">:</span> <span class="n">levelsSpin</span><span class="p">)</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">cancellables</span><span class="p">)</span>
</div></code></pre><p>Mixing reactive frameworks is no more an issue üëç.</p><h1>Using Spin in a UI perspective</h1><p>Although a feedback loop can exist by itself without any visualization, it makes more sense in our developer world to use it as a way to produce a State that will be rendered on a screen and a way to handle events emitted by the users. Fortunately, taking a State as an input for rendering and returning a stream of events from the user interactions looks A LOT like the definition of a feedback, and we know how to handle feedbacks üòÅ, with a Spin of course. Once a Spin/feedback loop is built, we can ‚Äúdecorate‚Äù it with a new feedback dedicated to the UI rendering/interactions. A special type of Spin exists to perform that decoration: UISpin. As a global picture, we can illustrate a feedback loop in the context of a UI with this diagram:</p><img src="/Images/2020-03-26-Spin/2.png"/><blockquote><p>a Spin in the context of a UI usage</p></blockquote><p>In a ViewController, let‚Äôs say you have a rendering function like:</p><pre><code><div class="highlight"><span></span><span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">state</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">increasing</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">counterLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="s">&quot;</span><span class="si">\(</span><span class="n">value</span><span class="si">)</span><span class="s">&quot;</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">counterLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="p">=</span> <span class="p">.</span><span class="n">green</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">decreasing</span><span class="p">(</span><span class="kd">let</span> <span class="nv">value</span><span class="p">):</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">counterLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="s">&quot;</span><span class="si">\(</span><span class="n">value</span><span class="si">)</span><span class="s">&quot;</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">counterLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="p">=</span> <span class="p">.</span><span class="n">red</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>We need to decorate the ‚Äúbusiness‚Äù Spin with a UISpin (in the <code>viewDidLoad</code> function for instance).</p><pre><code><div class="highlight"><span></span><span class="c1">// previously defined or injected: counterSpin is the Spin that handles our counter rules</span>
<span class="kc">self</span><span class="p">.</span><span class="n">uiSpin</span> <span class="p">=</span> <span class="n">UISpin</span><span class="p">(</span><span class="n">spin</span><span class="p">:</span> <span class="n">counterSpin</span><span class="p">)</span>
<span class="c1">// self.uiSpin is now able to handle UI side effects</span>

<span class="c1">// we now want to attach the UI Spin to the rendering function of the ViewController:</span>
<span class="kc">self</span><span class="p">.</span><span class="n">uiSpin</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="kc">self</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span> <span class="p">})</span>
<span class="c1">// And once the view is ready (in ‚ÄúviewDidLoad‚Äù function for instance) let‚Äôs start the loop:</span>
<span class="kc">self</span><span class="p">.</span><span class="n">uiSpin</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="c1">// the underlying reactive stream will be disposed once the uiSpin will be deinit</span>
</div></code></pre><p>Sending events in the loop is very straightforward; simply use the emit function:</p><pre><code><div class="highlight"><span></span><span class="kc">self</span><span class="p">.</span><span class="n">uiSpin</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Event</span><span class="p">.</span><span class="n">startCounter</span><span class="p">)</span>
</div></code></pre><h1>What about SwiftUI ?</h1><p>Because SwiftUI relies on the idea of a binding between a State and a View and takes care of the rendering, the way to connect a SwiftUI Spin is slightly different, and even simpler. In your view you have to annotate the SwiftUI Spin variable with ‚Äú@ObservedObject‚Äù:</p><pre><code><div class="highlight"><span></span><span class="p">@</span><span class="n">ObservedObject</span>
<span class="kd">private</span> <span class="kd">var</span> <span class="nv">uiSpin</span><span class="p">:</span> <span class="n">SwiftUISpin</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Event</span><span class="p">&gt;</span> <span class="p">=</span> <span class="p">{</span>
    <span class="c1">// previously defined or injected: counterSpin is the Spin that handles our counter business</span>
    <span class="kd">let</span> <span class="nv">spin</span> <span class="p">=</span> <span class="n">SwiftUISpin</span><span class="p">(</span><span class="n">spin</span><span class="p">:</span> <span class="n">counterSpin</span><span class="p">)</span>
    <span class="n">spin</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">spin</span>
<span class="p">}()</span>
</div></code></pre><p>You can then use the ‚ÄúuiSpin.state‚Äù property inside the view to display data and uiSpin.emit() to send events. As a SwiftUISpin is also an <code>ObservableObject</code>, every state mutation will trigger a view rendering.</p><pre><code><div class="highlight"><span></span><span class="n">Button</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="p">{</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">uiSpin</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Event</span><span class="p">.</span><span class="n">startCounter</span><span class="p">)</span>
<span class="p">})</span> <span class="p">{</span>
    <span class="n">Text</span><span class="p">(</span><span class="s">&quot;</span><span class="si">\(</span><span class="kc">self</span><span class="p">.</span><span class="n">uiSpin</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">isCounterPaused</span> <span class="p">?</span> <span class="s">&quot;Start&quot;</span><span class="p">:</span> <span class="s">&quot;Stop&quot;</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// A SwiftUISpin can also be used to produce SwiftUI bindings:</span>
<span class="n">Toggle</span><span class="p">(</span><span class="n">isOn</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">uiSpin</span><span class="p">.</span><span class="n">binding</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="n">isPaused</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="p">.</span><span class="n">toggle</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Text</span><span class="p">(</span><span class="s">&quot;toggle&quot;</span><span class="p">)</span>
<span class="p">}</span>
       
<span class="c1">// \.isPaused is a keypath which designates a sub state of the state,</span>
<span class="c1">// and .toggle is the event to emit when the Toggle is changed.</span>
</div></code></pre><p>The UIKit (AppKit) and SwiftUI ways of using a UISpin are very similar allowing you to integrate feedback loops previously written for UIKit screens inside new SwiftUI components. Mixing UI paradigms is no more an issue üëç.</p><h1>Conclusion</h1><p>We have reached our goal: to propose an architectural pattern implementation that can ease the transitions between incoming technologies. In the Spinners organization, you can find 2 demo applications demonstrating the usage of Spin with RxSwift, ReactiveSwift, and Combine:</p><ul><li>A basic counter application: <a href="https://github.com/Spinners/Spin.UIKit.Demo.Basic">UIKit version</a> and <a href="https://github.com/Spinners/Spin.SwiftUI.Demo.Basic">SwiftUI version</a></li><li>A more advanced ‚Äúnetwork based‚Äù application using dependency injection and a coordinator pattern (UIKit): <a href="https://github.com/Spinners/Spin.UIKit.Demo">UIKit version</a> and <a href="https://github.com/Spinners/Spin.SwiftUI.Demo">SwiftUI version</a></li></ul><p>There is the <a href="https://github.com/Spinners/Spin.Swift">Spin.Swift repo</a>. PR are of course welcome (so as ‚≠êÔ∏è üòè). I am planning to develop a Kotlin implementation, compatible with both RxJava and Flow (any help would be appreciated). I hope you enjoyed this article. Feel free to leave comments so we can exchange about it.</p></article></main><div class="flex flex-wrap w-full items-center font-sans p-8 md:p-24"><div class="md:flex-1 flex"><img class="w-10 h-10 rounded-full mr-4" src="/Images/avatar.png" alt="Thibault Wittemberg"/><div class="flex-1"><p class="text-base font-bold text-base md:text-xl leading-none">Thibault Wittemberg</p><p class="text-gray-600 text-xs md:text-base">Mobile Solution Architect in Montreal üá®üá¶ (thibault.wittemberg@gmail.com)</p></div></div><div class="mt-8 md:mt-0 mx-auto md:mx-0 md:justify-end"><a class="bg-transparent border border-gray-500 hover:border-casper-blue text-xs text-gray-500 hover:text-casper-blue font-bold py-2 px-4 rounded-full" href="/tags">All tags</a></div></div></div></div><div class="bg-gray-200"><div class="container w-full max-w-6xl mx-auto px-2 py-8"><div class="grid grid-cols-1 sm:grid-cols-3 gap-12"><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2021-02-13-StateMachineDSL" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2021-02-13-StateMachineDSL/header.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">ARCHITECTURE, OPEN SOURCE, LANGUAGE</p><div class="w-full font-bold text-2xl text-gray-900 px-6">A DSL for state machines in Swift</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">State machines are great tools to describe systems with a finite number of states. They are predictable and testable, which is something we praise for as developers. State machines can be defined in a pretty abstract way, which makes it a good candidate for a Domain Specific Language implementation. In this article, we will try to create a DSL that can describe state machines in Swift and use it in a feedback loop architecture.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">15 MIN READ</p></div></div></div><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2017-12-22-RxFlow-Part3" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2017-12-22-RxFlow-Part3/RxFlow_Logo.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">OPEN SOURCE, REACTIVE PROGRAMMING</p><div class="w-full font-bold text-2xl text-gray-900 px-6">RxFlow Part 3: Tips and tricks</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">This is the final chapter of our journey within RxFlow. I‚Äôve already exposed all the key features/principles of the framework in these 2 previous parts, let‚Äôs dive into some tips and tricks I used thanks to Reactive Programming.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">8 MIN READ</p></div></div></div><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2017-11-22-VersatileNamespace" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2017-11-22-VersatileNamespace/space.jpg" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">TIPS</p><div class="w-full font-bold text-2xl text-gray-900 px-6">Versatile Namespace</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">In Swift, some APIs such as RxSwift use a technic that confines the code they‚Äôre exposing in a dedicated namespace. In this post we will figure out how this is done in the most generic and versatile way.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">4 MIN READ</p></div></div></div></div></div></div><footer class="bg-gray-900"><div class="container max-w-6xl mx-auto flex items-center px-2 pt-2 pb-8"><div class="w-full mx-auto flex flex-wrap items-center"><div class="flex w-full md:w-1/2 justify-center md:justify-start text-white font-extrabold"><p><a class="text-gray-900 no-underline hover:text-gray-900 hover:no-underline" href="#"><span class="text-base text-gray-200">Warp your mobile development</span></a></p></div><div class="flex w-full pt-2 content-center justify-between md:w-1/2 md:justify-end"><ul class="list-reset flex justify-center flex-1 md:flex-none items-center"><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="/">Latest Posts</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="https://github.com/JohnSundell/Publish">Publish</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="https://ghost.org">Ghost</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline px-3 text-sm" href="/feed.rss"><svg class="fill-current h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"></circle><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"></path></svg></a></li></ul></div></div></div></footer></body></html>