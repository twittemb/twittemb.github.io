<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Warp your mobile development"/><link rel="canonical" href="http://blog.warpfactor.io/posts/2017-11-09-TypeErasure"/><meta name="twitter:url" content="http://blog.warpfactor.io/posts/2017-11-09-TypeErasure"/><meta name="og:url" content="http://blog.warpfactor.io/posts/2017-11-09-TypeErasure"/><title>Type erasure in Swift | Warp your mobile development</title><meta name="twitter:title" content="Type erasure in Swift | Warp your mobile development"/><meta name="og:title" content="Type erasure in Swift | Warp your mobile development"/><meta name="description" content="With Swift, you can define protocols by associating one or more generic types. These types are defined using the associatedtype keyword. The name ‚ÄúGeneric Type‚Äù is a bit usurped here, we should talk about a placeholder for a reserved type. Indeed, we will see that such protocols do not offer great flexibility of use when it comes to consider them as generic."/><meta name="twitter:description" content="With Swift, you can define protocols by associating one or more generic types. These types are defined using the associatedtype keyword. The name ‚ÄúGeneric Type‚Äù is a bit usurped here, we should talk about a placeholder for a reserved type. Indeed, we will see that such protocols do not offer great flexibility of use when it comes to consider them as generic."/><meta name="og:description" content="With Swift, you can define protocols by associating one or more generic types. These types are defined using the associatedtype keyword. The name ‚ÄúGeneric Type‚Äù is a bit usurped here, we should talk about a placeholder for a reserved type. Indeed, we will see that such protocols do not offer great flexibility of use when it comes to consider them as generic."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Warp your mobile development"/></head><body class="bg-white font-sans leading-normal tracking-normal"><div class="pb-16"><nav class="fixed z-10 bg-gray-900 p-4 mt-0 w-full overflow-auto scrolling-touch"><div class="container mx-auto flex items-center"><div class="flex-shrink-0 text-white font-extrabold"><a class="flex text-white text-base no-underline hover:text-white hover:no-underline" href="/"><span class="block md:hidden md:w-auto pl-1">üçè</span><span class="hidden md:block w-0 md:w-auto pl-1">Warp your mobile development</span></a></div><div class=" flex flex-no-wrap pl-4 text-sm"><ul class="list-reset flex justify-between items-center"><li class="mr-2"><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-2" href="/">HOME</a></li><li><a class="inline-block py-2 px-2 text-white no-underline hover:underline whitespace-no-wrap" href="/posts">MY POSTS</a></li></ul></div></div></nav></div><div class="text-center pt-16 md:pt-32"><p class="text-xs md:text-sm text-casper-blue font-bold">09 NOVEMBRE 2017<span class="text-gray-900 px-1">/</span><a href="/tags/tips">TIPS</a></p><h1 class="font-bold break-normal text-3xl md:text-5xl max-w-6xl mx-auto">Type erasure in Swift</h1></div><div class="container w-full max-w-6xl h-48 md:h-cover mx-auto bg-white bg-cover bg-center mt-8 sm:rounded" style="background-color: #465059; background-image:url('/Images/2017-11-09-TypeErasure/Erase-data.jpg');"></div><div class="container max-w-5xl mx-auto md:-mt-32"><div class="mx-0 sm:mx-6"><main class="bg-white w-full p-8 md:p-24 text-gray-800 leading-normal"><article class="prose prose-sm sm:prose-xl break-words"><p>With Swift, you can define protocols by associating one or more generic types. These types are defined using the <strong>associatedtype</strong> keyword. The name ‚Äú<strong>Generic Type</strong>‚Äù is a bit usurped here, we should talk about a placeholder for a reserved type. Indeed, we will see that such protocols do not offer great flexibility of use when it comes to consider them as generic.</p><h1>Imagine some protocols</h1><p>In the rest of this article we will rely on a simple case: A <strong>Cup</strong> is a type that can accommodate any type of <strong>Liquid</strong>. We will obviously use protocols to define these two types.</p><p>A <strong>Liquid</strong> is a protocol that exposes three properties: a color, a viscosity and a temperature (which is mutable)</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Liquid</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">temperature</span><span class="p">:</span> <span class="nb">Float</span> <span class="p">{</span> <span class="kr">get</span> <span class="kr">set</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">viscosity</span><span class="p">:</span> <span class="nb">Float</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">color</span><span class="p">:</span> <span class="nb">String</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>A Cup is a protocol that declares using the <strong>LiquidType</strong> associatedtype. This associated type must be respect the <strong>Liquid</strong> protocol described above. A <strong>Cup</strong> exposes a simple property of type <strong>LiquidType</strong>, as well as a function to fill it.</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Cup</span> <span class="p">{</span>
    <span class="n">associatedtype</span> <span class="n">LiquidType</span><span class="p">:</span> <span class="n">Liquid</span>
    <span class="kd">var</span> <span class="nv">liquid</span><span class="p">:</span> <span class="n">LiquidType</span><span class="p">?</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">fill</span> <span class="p">(</span><span class="n">with</span> <span class="n">liquid</span><span class="p">:</span> <span class="n">LiquidType</span><span class="p">)</span>
<span class="p">}</span>
</div></code></pre><h1>Let‚Äôs implement</h1><p>First of all, two types of liquids: <strong>Coffee</strong> and <strong>Milk</strong>.</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">Coffee</span><span class="p">:</span> <span class="n">Liquid</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">viscosity</span><span class="p">:</span> <span class="nb">Float</span> <span class="p">=</span> <span class="mf">3.4</span>
    <span class="kd">let</span> <span class="nv">color</span> <span class="p">=</span> <span class="s">&quot;black&quot;</span>
    <span class="kd">var</span> <span class="nv">temperature</span><span class="p">:</span> <span class="nb">Float</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Milk</span><span class="p">:</span> <span class="n">Liquid</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">viscosity</span><span class="p">:</span> <span class="nb">Float</span> <span class="p">=</span> <span class="mf">2.2</span>
    <span class="kd">let</span> <span class="nv">color</span> <span class="p">=</span> <span class="s">&quot;white&quot;</span>
    <span class="kd">var</span> <span class="nv">temperature</span><span class="p">:</span> <span class="nb">Float</span>
<span class="p">}</span>
</div></code></pre><p>Then two types of cups: <strong>CeramicCup</strong> and <strong>PlasticCup</strong>. These classes are generic (to be able to accommodate any type of <strong>Liquid</strong>) and replace the associated type of the protocol <strong>Cup</strong> by a type <strong>L</strong>. By the way, we are indeed obliged to compel <strong>L</strong> to respect the <strong>Liquid</strong> protocol (as defined in the <strong>Cup</strong> protocol).</p><pre><code><div class="highlight"><span></span><span class="kd">class</span> <span class="nc">CeramicCup</span><span class="p">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">Liquid</span><span class="p">&gt;:</span> <span class="n">Cup</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">liquid</span><span class="p">:</span> <span class="n">L</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">fill</span><span class="p">(</span><span class="n">with</span> <span class="n">liquid</span><span class="p">:</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">liquid</span> <span class="p">=</span> <span class="n">liquid</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">liquid</span><span class="p">!.</span><span class="n">temperature</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">PlasticCup</span><span class="p">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">Liquid</span><span class="p">&gt;:</span> <span class="n">Cup</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">liquid</span><span class="p">:</span> <span class="n">L</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">fill</span><span class="p">(</span><span class="n">with</span> <span class="n">liquid</span><span class="p">:</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">liquid</span> <span class="p">=</span> <span class="n">liquid</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">liquid</span><span class="p">!.</span><span class="n">temperature</span> <span class="o">-=</span> <span class="mi">10</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>We now have two concrete types of <strong>Cup</strong> that can accommodate any type of <strong>Liquid</strong>.</p><h1>The compiler does not like it ‚Ä¶</h1><p>We would now be tempted to use our implementations like this:</p><img src="/Images/2017-11-09-TypeErasure/TypeErasure-Error.png"/><p><strong>And that‚Äôs a failure!</strong> We have all seen these kinds of creepy errors ‚Äú<em>Protocol ‚Äòxxx‚Äô cannot be used as a generic constraint because it has Self or associatedtype</em>‚Äù</p><p>It is actually impossible to use <strong>Cup</strong> as a generic type. The compiler does not tolerate the unknown represented by the type associated with the protocol. It would be like solving a system of equations with two unknowns knowing only one equation.</p><p>Even if we tried to help the compiler by explicitly specifying the associated type, we would be blocked since the <strong>Cup&lt;Coffee&gt;</strong> notation is not even possible.</p><h1>‚Ä¶ but Design patterns do</h1><p>Generic protocols will probably be supported one day if we refer to the <a href="https://github.com/apple/swift/blob/master/docs/GenericsManifesto.md">Generics Manifesto</a> published on the Swift Github. But in the meantime there is a trick to achieve our ends: the <strong>Type Erasure</strong>. As its name implies, it‚Äôs a technique that will allow us to erase the type associated with the protocol and make it generic. This trick may initially scare you because it is not trivial, but it only required to mechanically apply two well-known design patterns to get it done:</p><ul><li>Abstract class: <a href="https://en.wikipedia.org/wiki/Template_method_pattern">https://en.wikipedia.org/wiki/Template_method_pattern</a></li><li>Decorator: <a href="https://en.wikipedia.org/wiki/Decorator_pattern">https://en.wikipedia.org/wiki/Decorator_pattern</a></li></ul><h2>An abstract Cup</h2><p>In Swift there is no abstract class as we know it in Java. However, an abstract class is only a partial and non-instantiable implementation of a type. It is thus easy to write such an implementation of <strong>Cup</strong>. It is done by declaring a generic class respecting the protocol (just like <strong>CeramicCup</strong> or <strong>PlasticCup</strong>) but not allowing its use (the instructions <strong>fatalError</strong> prohibit us the direct use of <strong>AbstractCup</strong>)</p><pre><code><div class="highlight"><span></span><span class="kd">private</span> <span class="kd">class</span> <span class="nc">AbstractCup</span><span class="p">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">Liquid</span><span class="p">&gt;:</span> <span class="n">Cup</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">liquid</span><span class="p">:</span> <span class="n">L</span><span class="p">?</span> <span class="p">{</span>
        <span class="bp">fatalError</span><span class="p">(</span><span class="s">&quot;Must implement&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">fill</span><span class="p">(</span><span class="n">with</span> <span class="n">liquid</span><span class="p">:</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">fatalError</span><span class="p">(</span><span class="s">&quot;Must Implement&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>The first step of this technique is now reached, let‚Äôs go to the decoration.</p><h2>A cool decorated Cup</h2><p>If you have already used <strong>InputStream</strong> in Java, then you have used the <strong>Decorator</strong> pattern without necessarily realizing it. It is this pattern that allows a <strong>FileInputStream</strong> to be an <strong>InputStream</strong> while adding new features to it. <strong>FileInputStream</strong> will encapsulate a classic <strong>InputStream</strong> (given as a parameter of its constructor), while specializing certain behaviors. The interest of such a pattern is that you can indefinitely nest decorators without freezing the inheritance tree. This is how a <strong>BufferedInputStream</strong> can decorate a <strong>FileInputStream</strong> as well as a basic <strong>InputStream</strong>.</p><p>But back to our cups. In our case, we will build a decorator encapsulating a <strong>Cup</strong>. We already have the basic implementation of our <strong>Cup</strong> with <strong>AbstractCup&nbsp;</strong>(same thing as <strong>InputStream</strong> in the Java example), so we can define a wrapper (or decorator) that will inherit our <strong>AbstractCup</strong> while delegating the properties and function calls to the Cup that it encapsulates.</p><pre><code><div class="highlight"><span></span><span class="kr">final</span> <span class="kd">private</span> <span class="kd">class</span> <span class="nc">CupWrapper</span><span class="p">&lt;</span><span class="n">C</span><span class="p">:</span> <span class="n">Cup</span><span class="p">&gt;:</span> <span class="n">AbstractCup</span><span class="p">&lt;</span><span class="n">C</span><span class="p">.</span><span class="n">LiquidType</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">cup</span><span class="p">:</span> <span class="n">C</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">with</span> <span class="n">cup</span><span class="p">:</span> <span class="n">C</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">cup</span> <span class="p">=</span> <span class="n">cup</span>
    <span class="p">}</span>

    <span class="kr">override</span> <span class="kd">var</span> <span class="nv">liquid</span><span class="p">:</span> <span class="n">C</span><span class="p">.</span><span class="n">LiquidType</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">cup</span><span class="p">.</span><span class="n">liquid</span>
    <span class="p">}</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">fill</span><span class="p">(</span><span class="n">with</span> <span class="n">liquid</span><span class="p">:</span> <span class="n">C</span><span class="p">.</span><span class="n">LiquidType</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">cup</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">liquid</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>We can notice the constraint imposed on the <strong>Cup</strong> and <strong>LiquidType</strong> types. We must make sure that the type of liquid in the <strong>AbstractCup</strong> that we decorate is exactly the same as the one of the cup that we take in parameter in the constructor.</p><p><strong>CupWrapper</strong> is therefore at the same time a <strong>Cup</strong> and a <strong>Cup</strong> wrapper. In a way, it allows to transform a <strong>Cup</strong> (which is only a protocol) in a concrete type. But in the end, it is still well the <strong>Cup</strong> passed as a constructor parameter that will dictate the wrapper behavior.</p><p>At this stage of the process we already have a usable result and we have made our protocol usable in a generic way:</p><pre><code><div class="highlight"><span></span><span class="kd">var</span> <span class="nv">cupsOfCoffee</span> <span class="p">=</span> <span class="p">[</span><span class="n">AbstractCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;]()</span>
<span class="n">cupsOfCoffee</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">CupWrapper</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">CeramicCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;()))</span>
<span class="n">cupsOfCoffee</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">CupWrapper</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">PlasticCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;()))</span>
</div></code></pre><p>We managed to declare an array of cups of coffee. The <strong>associated type</strong> has been erased as expected.</p><h1>Refinement</h1><p>If we want to bring the concept of Type Erasure to an end (and in the same way that it is implemented in Swift‚Äôs standard library), we have one last step to go. I invite you to see the official documentation of the type AnyIterator (<a href="https://developer.apple.com/documentation/swift/anyiterator">Standard Swift Library</a>) to give you an idea of the final goal that we set ourselves.</p><p>I would first like to draw your attention to the declaration of the <strong>AbstractCup</strong> and <strong>CupWrapper</strong> classes. Everything has been done so that they are neither visible nor directly modifiable by the user of our model (<strong>final / private</strong>). The idea is to hide as much as possible the implementation of our Erasure Type pattern and to expose to the outside world only the simplest possible mechanism.</p><p>We will therefore provide a truly generic <strong>AnyCup</strong> class that will be a simple Cup wrapper. Somewhere it is a matter of applying a decorator pattern a second time directly on the Cup protocol (using under the hood our CupWrapper to delegate the work):</p><pre><code><div class="highlight"><span></span><span class="kr">final</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnyCup</span><span class="p">&lt;</span><span class="n">L</span><span class="p">:</span> <span class="n">Liquid</span><span class="p">&gt;:</span> <span class="n">Cup</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">abstractCup</span><span class="p">:</span> <span class="n">AbstractCup</span><span class="p">&lt;</span><span class="n">L</span><span class="p">&gt;</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">&lt;</span><span class="n">C</span><span class="p">:</span> <span class="n">Cup</span><span class="p">&gt;(</span><span class="n">with</span> <span class="n">cup</span><span class="p">:</span> <span class="n">C</span><span class="p">)</span> <span class="k">where</span> <span class="n">C</span><span class="p">.</span><span class="n">LiquidType</span> <span class="p">==</span> <span class="n">L</span> <span class="p">{</span>
        <span class="n">abstractCup</span> <span class="p">=</span> <span class="n">CupWrapper</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">cup</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">fill</span><span class="p">(</span><span class="n">with</span> <span class="n">liquid</span><span class="p">:</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">abstractCup</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">liquid</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">liquid</span><span class="p">:</span> <span class="n">L</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">abstractCup</span><span class="p">.</span><span class="n">liquid</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>Et voila ‚Ä¶</p><p>It gives us something quite simple and intuitive to use:</p><pre><code><div class="highlight"><span></span><span class="kd">var</span> <span class="nv">coffeeCups</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;]()</span>
<span class="n">coffeeCups</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;(</span><span class="n">with</span><span class="p">:</span> <span class="n">CeramicCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;()))</span>
<span class="n">coffeeCups</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;(</span><span class="n">with</span><span class="p">:</span> <span class="n">PlasticCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;()))</span>

<span class="n">coffeeCups</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">anyCup</span><span class="p">)</span> <span class="k">in</span>
    <span class="n">anyCup</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">Coffee</span><span class="p">(</span><span class="n">temperature</span><span class="p">:</span> <span class="mf">60.4</span><span class="p">))</span>
    <span class="bp">print</span><span class="p">(</span><span class="n">anyCup</span><span class="p">.</span><span class="n">liquid</span><span class="p">!.</span><span class="n">color</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="n">anyCup</span><span class="p">.</span><span class="n">liquid</span><span class="p">!.</span><span class="n">temperature</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">milkCups</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">Milk</span><span class="p">&gt;]()</span>
<span class="n">milkCups</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">Milk</span><span class="p">&gt;(</span><span class="n">with</span><span class="p">:</span> <span class="n">CeramicCup</span><span class="p">&lt;</span><span class="n">Milk</span><span class="p">&gt;()))</span>
<span class="n">milkCups</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">Milk</span><span class="p">&gt;(</span><span class="n">with</span><span class="p">:</span> <span class="n">PlasticCup</span><span class="p">&lt;</span><span class="n">Milk</span><span class="p">&gt;()))</span>

<span class="n">milkCups</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">anyCup</span><span class="p">)</span> <span class="k">in</span>
    <span class="n">anyCup</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">Milk</span><span class="p">(</span><span class="n">temperature</span><span class="p">:</span> <span class="mf">30.9</span><span class="p">))</span>
    <span class="bp">print</span><span class="p">(</span><span class="n">anyCup</span><span class="p">.</span><span class="n">liquid</span><span class="p">!.</span><span class="n">color</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="n">anyCup</span><span class="p">.</span><span class="n">liquid</span><span class="p">!.</span><span class="n">temperature</span><span class="p">)</span>
<span class="p">}</span>
</div></code></pre><p>The line of code that was causing us a problem:</p><pre><code><div class="highlight"><span></span><span class="kd">var</span> <span class="nv">cupsOfCoffee</span> <span class="p">=</span> <span class="p">[</span><span class="n">Cup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;]()</span>
</div></code></pre><p>becomes:</p><pre><code><div class="highlight"><span></span><span class="kd">var</span> <span class="nv">coffeeCups</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;]()</span>
</div></code></pre><p>The bet is won.</p><p>Personally, I still struggle today with the use of such a mechanism because it is really not so trivial and I have to re-read it several times to be sure to understand it well :-) But if we apply mechanically enough the steps I have just outlined, one is sure to arrive at the expected result, hoping not to have to write it for too long.</p><p>The code is accessible on my Github: <a href="https://github.com/twittemb/TypeErasure">Playground Type Erasure</a></p><p>I hope this can be helpful..</p><h1>Bonus</h1><p>We can even add a little helper function to the <strong>Cup</strong> protocol:</p><pre><code><div class="highlight"><span></span><span class="kd">extension</span> <span class="nc">Cup</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">toAnyCup</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">LiquidType</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">LiquidType</span><span class="p">&gt;(</span><span class="n">with</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>This is a nice shortcut that can be used this way:</p><pre><code><div class="highlight"><span></span><span class="kd">var</span> <span class="nv">coffeeCups</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;]()</span>
<span class="n">coffeeCups</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">CeramicCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;().</span><span class="n">toAnyCup</span><span class="p">())</span>
<span class="n">coffeeCups</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">PlasticCup</span><span class="p">&lt;</span><span class="n">Coffee</span><span class="p">&gt;().</span><span class="n">toAnyCup</span><span class="p">())</span>
</div></code></pre><p>pretty nice :-)</p><p>Stay tuned.</p><p><strong>[Update 2019-05-11]</strong></p><p>As I needed to setup "type erasure" for one of my professional project, I remembered a solution based on closures. I wanted to share it here as it is a very simple and elegant pattern.</p><p>A quick reminder of the protocols we had to "type erase":</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Liquid</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">temperature</span><span class="p">:</span> <span class="nb">Float</span> <span class="p">{</span> <span class="kr">get</span> <span class="kr">set</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">viscosity</span><span class="p">:</span> <span class="nb">Float</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">color</span><span class="p">:</span> <span class="nb">String</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>and</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Cup</span> <span class="p">{</span>
    <span class="n">associatedtype</span> <span class="n">LiquidType</span><span class="p">:</span> <span class="n">Liquid</span>
    <span class="kd">var</span> <span class="nv">liquid</span><span class="p">:</span> <span class="n">LiquidType</span><span class="p">?</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">fill</span> <span class="p">(</span><span class="n">with</span> <span class="n">liquid</span><span class="p">:</span> <span class="n">LiquidType</span><span class="p">)</span>
<span class="p">}</span>
</div></code></pre><p>Instead of creating an abstract Class and then a wrapper holding a reference on a type conforming to Cup, we can directly build a generic wrapper Class that will keep some references on the Cup's <strong>behaviors</strong>.</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnyCup</span><span class="p">&lt;</span><span class="n">LiquidType</span><span class="p">:</span> <span class="n">Liquid</span><span class="p">&gt;:</span> <span class="n">Cup</span> <span class="p">{</span>

    <span class="c1">// inner mechanism to &quot;remember&quot; the behavior of the cup</span>
    <span class="c1">// passed in the init function</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">fillClosure</span><span class="p">:</span> <span class="p">(</span><span class="n">LiquidType</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">liquidClosure</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">LiquidType</span><span class="p">?</span>

    <span class="kd">init</span><span class="p">&lt;</span><span class="n">CupType</span><span class="p">:</span> <span class="n">Cup</span><span class="p">&gt;(</span><span class="n">with</span> <span class="n">cup</span><span class="p">:</span> <span class="n">CupType</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">CupType</span><span class="p">.</span><span class="n">LiquidType</span> <span class="p">==</span> <span class="n">LiquidType</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">fillClosure</span> <span class="p">=</span> <span class="n">cup</span><span class="p">.</span><span class="n">fill</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">liquidClosure</span> <span class="p">=</span> <span class="p">{</span> <span class="k">return</span> <span class="n">cup</span><span class="p">.</span><span class="n">liquid</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// conformance to Cup protocol</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">liquid</span><span class="p">:</span> <span class="n">LiquidType</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">liquidClosure</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">fill</span><span class="p">(</span><span class="n">with</span> <span class="n">liquid</span><span class="p">:</span> <span class="n">LiquidType</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">fillClosure</span><span class="p">(</span><span class="n">liquid</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>You can see it as some kind of delegation mechanism. As we cannot keep a reference on a Cup because of its associated type, the wrapper keeps references on the Cup's functions and properties and is responsible for their execution.</p><p>Pretty straight forward üëç.</p></article></main><div class="flex flex-wrap w-full items-center font-sans p-8 md:p-24"><div class="md:flex-1 flex"><img class="w-10 h-10 rounded-full mr-4" src="/Images/avatar.png" alt="Thibault Wittemberg"/><div class="flex-1"><p class="text-base font-bold text-base md:text-xl leading-none">Thibault Wittemberg</p><p class="text-gray-600 text-xs md:text-base">Mobile Solution Architect in Montreal üá®üá¶</p></div></div><div class="mt-8 md:mt-0 mx-auto md:mx-0 md:justify-end"><a class="bg-transparent border border-gray-500 hover:border-casper-blue text-xs text-gray-500 hover:text-casper-blue font-bold py-2 px-4 rounded-full" href="/tags">All tags</a></div></div></div></div><div class="bg-gray-200"><div class="container w-full max-w-6xl mx-auto px-2 py-8"><div class="grid grid-cols-1 sm:grid-cols-3 gap-12"><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2018-06-25-RxReduce-Part2" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2018-06-25-RxReduce-Part2/RxReduce_Logo.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">ARCHITECTURE, REACTIVE PROGRAMMING, OPEN SOURCE</p><div class="w-full font-bold text-2xl text-gray-900 px-6">RxReduce: Reactive State Container Architecture Part 2</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">As we saw in ‚ÄúRxReduce: A Reactive State Container Architecture Part 1‚Äù, State is a central concern in applications. I strongly invite you to take a look at this first article. So far, we haven‚Äôt introduced the concept of Reactive Programming and how it can address some issues I‚Äôve encountered in traditional implementations of State Containers. We will see how RxReduce, an open source framework of the RxSwiftCommunity, can help you handle the State, its mutations, and the asynchronous work related to the side effects, in a Reactive way.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">11 MIN READ</p></div></div></div><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2019-06-18-PropertyWrappers" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2019-06-18-PropertyWrappers/wrapper.png" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">LANGUAGE</p><div class="w-full font-bold text-2xl text-gray-900 px-6">RxReduce: Property Wrappers In Swift 5.1 The Missing Published Implementation</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">It‚Äôs been an amazing WWDC this year. SwiftUI and Combine were some big announcements of the conference. They will have a huge impact on our daily life as iOS developers.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">6 MIN READ</p></div></div></div><div class="w-full  py-6 flex flex-col flex-grow flex-shrink transform transition duration-200 ease-in-out hover:scale-105"><div class="flex-1 bg-white rounded-t rounded-b-none overflow-hidden shadow-lg"><a href="/posts/2017-11-22-VersatileNamespace" class="flex flex-wrap no-underline hover:no-underline"><img src="/Images/2017-11-22-VersatileNamespace/space.jpg" class="h-64 w-full rounded-t object-cover"/><p class="w-full text-casper-blue text-xs font-medium pt-6 px-6">TIPS</p><div class="w-full font-bold text-2xl text-gray-900 px-6">Versatile Namespace</div><p class="text-gray-800 font-serif text-lg px-6 mb-5">In Swift, some APIs such as RxSwift use a technic that confines the code they‚Äôre exposing in a dedicated namespace. In this post we will figure out how this is done in the most generic and versatile way.</p></a></div><div class="flex-none mt-auto bg-white rounded-b rounded-t-none overflow-hidden shadow-lg p-6"><div class="flex items-center justify-between"><img class="w-8 h-8 rounded-full mr-4 avatar" src="/Images/avatar.png" alt="Thibault Wittemberg"/><p class="text-gray-600 text-xs md:text-sm">4 MIN READ</p></div></div></div></div></div></div><footer class="bg-gray-900"><div class="container max-w-6xl mx-auto flex items-center px-2 pt-2 pb-8"><div class="w-full mx-auto flex flex-wrap items-center"><div class="flex w-full md:w-1/2 justify-center md:justify-start text-white font-extrabold"><p><a class="text-gray-900 no-underline hover:text-gray-900 hover:no-underline" href="#"><span class="text-base text-gray-200">Warp your mobile development</span></a></p></div><div class="flex w-full pt-2 content-center justify-between md:w-1/2 md:justify-end"><ul class="list-reset flex justify-center flex-1 md:flex-none items-center"><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="/">Latest Posts</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="https://github.com/JohnSundell/Publish">Publish</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline py-2 px-3 text-sm" href="https://ghost.org">Ghost</a></li><li><a class="inline-block text-gray-600 no-underline hover:text-gray-200 hover:underline px-3 text-sm" href="/feed.rss"><svg class="fill-current h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"></circle><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"></path></svg></a></li></ul></div></div></div></footer></body></html>